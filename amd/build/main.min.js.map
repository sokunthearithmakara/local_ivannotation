{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["\n/* eslint-disable complexity */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main script for the annotation plugin\n *\n * @module     local_ivannotation/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport ModalForm from 'core_form/modalform';\nimport {notifyFilterContentUpdated as notifyFilter} from 'core_filters/events';\nimport Notification from 'core/notification';\n\nexport default class Annotation extends Base {\n    /**\n     * Round a number to two decimal places\n     * @param {Number} num Number\n     * @returns {Number} rounded number\n     */\n    roundToTwo(num) {\n        return +(Math.round(num + 'e+2') + 'e-2');\n    }\n\n    /**\n     * Initialize the annotation type\n     * @returns {void}\n     */\n    async init() {\n        const videoWrapper = $('#video-wrapper');\n        let self = this;\n        let item = this.annotations.find((annotation) => annotation.type == 'annotation');\n        if (!this.isEditMode()) {\n            if (!item || item.content == '') {\n                return;\n            }\n            const updateAspectRatio = async(video, reset) => {\n                let elem = video ? $('#player') : $(`#annotation-canvas[data-id='${item.id}']`);\n                if ($(\"#wrapper\").hasClass('fullscreen')) {\n                    let ratio = 16 / 9; // #player aspect ratio.\n                    if (!this.displayoptions.usefixedratio || this.displayoptions.usefixedratio == 0) {\n                        ratio = this.player.aspectratio;\n                    }\n                    let videowrapperaspect = videoWrapper.width() / videoWrapper.height();\n                    const videowrapperwidth = videoWrapper.width();\n                    const videowrapperheight = videoWrapper.height();\n                    // Screen is wider than the video.\n                    if (videowrapperaspect > ratio) {\n                        let height = videowrapperheight;\n                        let width = height * ratio;\n                        elem.css('height', height + 'px');\n                        elem.css('width', width + 'px');\n                        elem.css('top', '0');\n                        elem.css('left', (videowrapperwidth - width) / 2 + 'px');\n                    } else if (videowrapperaspect < ratio) {\n                        let width = videowrapperwidth;\n                        let height = width / ratio;\n                        elem.css('width', width + 'px');\n                        elem.css('height', height + 'px');\n                        elem.css('top', ((videowrapperheight - height) / 2) + 'px');\n                        elem.css('left', '0');\n                    }\n                } else {\n                    elem.css('width', '100%');\n                    elem.css('height', '100%');\n                    elem.css('top', '0');\n                    elem.css('left', '0');\n                }\n                if (reset) {\n                    elem.css('width', '100%');\n                    elem.css('height', '100%');\n                    elem.css('top', '0');\n                    elem.css('left', '0');\n                }\n            };\n\n            updateAspectRatio();\n            updateAspectRatio(true);\n\n            let vwrapper = document.querySelector('#video-wrapper');\n            let resizeTimeout;\n            let resizeObserver = new ResizeObserver(() => {\n                clearTimeout(resizeTimeout);\n                resizeTimeout = setTimeout(() => {\n                    updateAspectRatio();\n                    updateAspectRatio(true);\n                }, 100);\n            });\n            resizeObserver.observe(vwrapper);\n\n            $(document).on('timeupdate', function() {\n                updateAspectRatio(true, true);\n            });\n\n            $('#annotation-canvas').attr('data-id', item.id);\n            let content = await this.render(item, 'json');\n            await this.postContentRender(item, content);\n        } else {\n            if (item) {\n                $('#annotation-canvas').attr('data-id', item.id);\n                item.editmode = true;\n                let content = await this.render(item, 'json');\n                await this.postContentRender(item, content);\n            }\n        }\n\n        $('#annotation-canvas .dismiss-btn').off('click').on('click', function() {\n            $(this).closest('.annotation-wrapper').remove();\n        });\n\n        let annos = $('#annotation-canvas .annotation-wrapper');\n        annos = annos.map(function() {\n            return {\n                self: $(this),\n                id: $(this).attr('data-item'),\n                start: Number($(this).attr('data-start')),\n                end: Number($(this).attr('data-end')),\n                type: $(this).attr('data-type'),\n                duration: Number($(this).attr('data-duration')) || 0,\n                video: $(this).find('video, audio')[0],\n            };\n        }).get();\n\n        // Update annos on annotationChanged event\n        $(document).on('annotationChanged.Annotation', async function() {\n            annos = $('#annotation-canvas .annotation-wrapper');\n            annos = annos.map(function() {\n                let video = $(this).find('video, audio')[0];\n                if (video) {\n                    video.pause();\n                }\n                return {\n                    self: $(this),\n                    id: $(this).attr('data-item'),\n                    start: Number($(this).attr('data-start')),\n                    end: Number($(this).attr('data-end')),\n                    type: $(this).attr('data-type'),\n                    duration: Number($(this).attr('data-duration')) || 0,\n                    video: video,\n                };\n            }).get();\n\n            self.dispatchEvent('timeupdate', {time: await self.player.getCurrentTime()});\n        });\n\n        $(document).on('iv:playerReload.Annotation', async function(e) {\n            if (e.originalEvent.detail.main) { // If this is the main video.\n                annos = $('#annotation-canvas .annotation-wrapper');\n                annos = annos.map(function() {\n                    let video = $(this).find('video, audio')[0];\n                    if (video) {\n                        video.pause();\n                    }\n                    return {\n                        self: $(this),\n                        id: $(this).attr('data-item'),\n                        start: Number($(this).attr('data-start')),\n                        end: Number($(this).attr('data-end')),\n                        type: $(this).attr('data-type'),\n                        duration: Number($(this).attr('data-duration')) || 0,\n                        video: video,\n                    };\n                }).get();\n            } else {\n                annos = annos.map(x => {\n                    x.start = self.start;\n                    x.end = self.start;\n                    return x;\n                });\n            }\n            self.dispatchEvent('timeupdate', {time: await self.player.getCurrentTime()});\n        });\n\n        $(document).on('timeupdate.Annotation', async function(e) {\n            if (annos.length == 0) {\n                return;\n            }\n            let t = e.originalEvent.detail.time;\n            let hasMute = false;\n\n            // Filter the annos based on the current time.\n            let visibles = annos.filter(x => t >= x.start && t <= x.end);\n            let hiddens = annos.filter(x => t < x.start || t > x.end);\n            let toShow = visibles.filter(x => !x.activated);\n            let toHide = hiddens.filter(x => !x.activated);\n\n            // At the beginning, activated isn't available yet.\n            if (annos[0].activated == undefined) {\n                toShow = visibles;\n                toHide = hiddens;\n            }\n\n            toShow.map(async(x) => {\n                x.self.css('visibility', 'visible');\n                let isPaused = await self.player.isPaused();\n                if (x.type == 'video' || x.type == 'audio') {\n                    let video = x.video;\n                    if (video) {\n                        if (isPaused) {\n                            video.pause();\n                        } else {\n                            video.play();\n                        }\n                    }\n                }\n                if ((x.type == 'link' || x.type == 'message') && !self.isEditMode()) {\n                    x.self.find('a, .message-wrapper').addClass('show');\n                }\n\n                return x.id;\n            });\n\n            toHide.map(x => {\n                x.self.css('visibility', 'hidden');\n                if (x.type == 'video' || x.type == 'audio') {\n                    let video = x.video;\n                    if (video) {\n                        video.pause();\n                    }\n                }\n                if ((x.type == 'link' || x.type == 'message') && !self.isEditMode()) {\n                    x.self.find('a, .message-wrapper').removeClass('show');\n                }\n                return x.id;\n            });\n\n            annos.forEach(async function(anno) {\n                if (anno.type == 'mute') { // If mute exists.\n                    hasMute = true;\n                }\n                if (toHide.includes(anno.id)) {\n                    anno.activated = false;\n                }\n                if (toShow.includes(anno.id)) {\n                    anno.activated = true;\n                }\n            });\n\n            if (!hasMute) {\n                return;\n            }\n\n            // Check if there is any active mute item. This is done so because we don't want to call isMuted() on every frame.\n            let muteElem = annos.filter(x => x.type == 'mute' && x.start <= t && x.end >= t); // If mute is active.\n            let isMuted = await self.player.isMuted();\n            if (muteElem.length > 0 && !isMuted) {\n                self.player.mute();\n            } else if (muteElem.length === 0 && isMuted) {\n                self.player.unMute();\n            }\n        });\n\n        // Handle speed change.\n        $(document).off('iv:playerRateChange.Annotations').on('iv:playerRateChange.Annotations', function(e) {\n            let rate = e.detail.rate;\n            let videos = annos.filter(x => x.video);\n            videos.forEach(x => {\n                x.video.playbackRate = rate;\n            });\n        });\n\n        // Event listener to pause all the videos when the player is paused or ended.\n        $(document).on('videoPaused.Annotations iv:playerPaused.Annotations iv:playerEnded.Annotations', function() {\n            let videos = annos.filter(x => x.video);\n            videos.forEach(x => x.video.pause());\n        });\n\n        $(document).off('iv:playerSeek.Annotation').on('iv:playerSeek.Annotation', async function() {\n            let currentTime = await self.player.getCurrentTime();\n            let videos = annos.filter(x => x.video && x.start <= currentTime && x.end >= currentTime);\n            videos.forEach(x => {\n                x.video.currentTime = currentTime - x.start;\n            });\n\n            if (self.isEditMode()) {\n                return;\n            }\n\n            let links = annos.filter(x => (x.type == 'link' || x.type == 'message')\n                && x.start <= currentTime && x.end >= currentTime);\n            links.forEach(x => {\n                x.self.find('a, .message-wrapper').addClass('show');\n            });\n        });\n    }\n\n    /**\n     * Render the annotation toolbar\n     * @param {Object} annotation annotation object\n     * @returns {void}\n     */\n    async renderAnnotationToolbar(annotation) {\n        $('#annotation-btns').remove();\n        let annotationitems = [\n            {\n                'icon': 'bi bi-image',\n                'type': 'media',\n                'mediatype': 'image',\n                'label': M.util.get_string('image', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-film',\n                'type': 'media',\n                'mediatype': 'video',\n                'label': M.util.get_string('video', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-volume-up',\n                'type': 'media',\n                'mediatype': 'audio',\n                'label': M.util.get_string('audio', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-volume-mute',\n                'type': 'mute',\n                'mediatype': 'mute',\n                'label': M.util.get_string('mute', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-alphabet-uppercase',\n                'type': 'textblock',\n                'mediatype': 'textblock',\n                'label': M.util.get_string('text', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-circle-square',\n                'type': 'shape',\n                'mediatype': 'shape',\n                'label': M.util.get_string('shape', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-file-earmark-arrow-down',\n                'type': 'media',\n                'mediatype': 'file',\n                'label': M.util.get_string('inlinefile', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-sign-turn-right',\n                'type': 'navigation',\n                'mediatype': 'navigation',\n                'label': M.util.get_string('navigation', 'local_ivannotation')\n            },\n            {\n                'icon': 'bi bi-plus-circle',\n                'type': 'hotspot',\n                'mediatype': 'hotspot',\n                'label': M.util.get_string('hotspot', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-link-45deg',\n                'type': 'link',\n                'mediatype': 'link',\n                'label': M.util.get_string('externallink', 'local_ivannotation'),\n            },\n            {\n                'icon': 'bi bi-bell',\n                'type': 'message',\n                'mediatype': 'message',\n                'label': M.util.get_string('message', 'local_ivannotation'),\n            },\n\n        ];\n        const dataForTemplate = {\n            id: annotation.id,\n            items: annotationitems,\n        };\n\n        let html = await Templates.render('local_ivannotation/toolbar', dataForTemplate);\n        $(\"#wrapper\").append(html);\n\n        this.enableColorPicker();\n    }\n\n    /**\n     * Callback after the content is retrieved\n     * @param {Object} annotation annotation object\n     * @param {Object} data data processed through the main php file\n     */\n    async postContentRender(annotation, data) {\n        let self = this;\n        let $videoWrapper = $('#annotation-canvas');\n\n        // Put a background so that when an annotation is selected, user is prevented from clicking on the video.\n        if (self.isEditMode()) {\n            $videoWrapper.append(`<div id=\"background\" class=\"position-absolute w-100 h-100 bg-transparent d-none\"></div>`);\n        }\n        let $playerWrapper = $('#wrapper');\n        let draftStatus = null;\n\n        /**\n         * Format seconds to HH:MM:SS\n         * @param {Number} seconds seconds\n         * @param {Boolean} rounded if the seconds should be rounded\n         * @returns formatted time\n         */\n        const convertSecondsToMMSS = (seconds, rounded = false) => {\n            let hours = Math.floor(seconds / 3600);\n            let minutes = Math.floor((seconds - hours * 3600) / 60);\n            let sec = seconds - hours * 3600 - minutes * 60;\n            let formattedTime = '';\n            if (hours > 0) {\n                formattedTime += hours + ':';\n            }\n            if (minutes < 10) {\n                formattedTime += '0';\n            }\n            formattedTime += minutes + ':';\n            if (sec < 10) {\n                formattedTime += '0';\n            }\n            if (rounded) {\n                formattedTime += Math.round(sec);\n            } else {\n                formattedTime += self.roundToTwo(sec);\n            }\n            return formattedTime;\n        };\n\n        /**\n         * Update position information of the active element on the toolbar.\n         * @param {Object} elem jQuery element\n         */\n        const updatePositionInfo = (elem) => {\n            let w = elem.outerWidth();\n            let hw = elem.outerHeight();\n            let t = elem.position().top < 0 ? 0 : elem.position().top;\n            let l = elem.position().left < 0 ? 0 : elem.position().left;\n            let z = elem.css('z-index');\n            let s = elem.attr('data-start');\n            let e = elem.attr('data-end');\n            let $position = $('#annotation-btns #position');\n            $position.find('#x-position').text(Math.round(l));\n            $position.find('#y-position').text(Math.round(t));\n            $position.find('#z-position').text(z - 5);\n            $position.find('#w-position').text(Math.round(w));\n            $position.find('#h-position').text(Math.round(hw));\n            $position.find('#s-position').text(convertSecondsToMMSS(s));\n            $position.find('#e-position').text(convertSecondsToMMSS(e));\n        };\n\n        /**\n         * Recalculate the size of the element.\n         * @param {Object} elem jQuery element\n         * @return {Object} position of the element\n         */\n        const recalculatingSize = (elem) => {\n            let message = $('#annotation-canvas');\n            let w = elem.outerWidth() / message.width() * 100;\n            let h = elem.outerHeight() / message.height() * 100;\n            let t = elem.position().top / message.height() * 100;\n            t = t < 0 ? 0 : t;\n            let l = elem.position().left / message.width() * 100;\n            l = l < 0 ? 0 : l;\n            let z = elem.css('z-index');\n            let g = elem.attr('data-group');\n            let position = {\n                'width': w + '%',\n                'height': h + '%',\n                'left': l + '%',\n                'top': t + '%',\n                'z-index': z,\n            };\n            position.group = g;\n            elem.css(position);\n            updatePositionInfo(elem);\n            return position;\n        };\n\n        /**\n         * Calculate the text size for text and file type.\n         * @param {Object} elem jQuery element\n         * @param {Boolean} button if it is a button\n         * @param {Boolean} multiline if it is a multiline text\n         */\n        const recalculatingTextSize = (elem, button, multiline = false) => {\n            let fontSize = elem.outerHeight();\n            let padding = 0;\n            let rowCount = 1;\n            if (multiline) {\n                let rows = elem.find('.text-row');\n                rowCount = rows.length;\n                if (rowCount > 1) {\n                    let rowHeight = elem.outerHeight() / rowCount;\n                    padding = rowHeight * 0.3;\n                    fontSize = (elem.outerHeight() - padding * 2) / rowCount;\n                }\n            }\n            let style = {\n                'font-size': (button ? fontSize * 0.7 : fontSize * 0.9) + 'px',\n                'line-height': fontSize + 'px',\n                'padding-left': (button ? fontSize * 0.5 : fontSize * 0.3) + 'px',\n                'padding-right': (button ? fontSize * 0.5 : fontSize * 0.3) + 'px',\n            };\n            if (multiline && rowCount > 1) {\n                style.padding = padding + 'px';\n            }\n            elem.find('.annotation-content').css(style);\n            elem.css('width', 'auto');\n        };\n\n        /**\n         * Render timeline items.\n         * @param {Array} elements array of elements to render\n         * @param {Number} activeids array of ids of active elements\n         */\n        const renderTimelineItems = async(elements, activeids) => {\n            const currentTime = await self.player.getCurrentTime();\n            if (activeids === null) {\n                activeids = [];\n            } else {\n                activeids = activeids.map(id => parseInt(id));\n            }\n            let $timelinewrapper = $('#timeline #timeline-items-wrapper');\n            let timeline = $timelinewrapper.find('#annotation-timeline');\n            timeline.empty();\n            elements.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n            let count = 0;\n            let timelineHTML = '';\n            elements.forEach((item, i) => {\n                let prop = item.properties;\n                let type = item.type;\n                let id = parseInt(item.id);\n                let left = (prop.start - self.start) / (self.end - self.start) * 100;\n                let width = (prop.end - prop.start) / (self.end - self.start) * 100;\n                timelineHTML += `<div class=\"annotation-timeline-item position-absolute ${activeids.includes(id) ? 'active' : ''}\"\n                     data-item=\"${id}\" data-type=\"${type}\" data-end=\"${prop.end}\" data-start=\"${prop.start}\"\n                     data-duration=\"${prop.duration}\"\n                         style=\"z-index: 5; left: ${left}%; top: ${(i + 1) * 10}px; width: ${width}%\">\n                         <div class=\"annotation-timeline-item-content\">\n                            ${M.util.get_string(type, 'local_ivannotation')}\n                            </div>\n                         </div>`;\n                count++;\n                if (count == elements.length) {\n                    timeline.append(timelineHTML);\n                    // Initialize the draggable and resizable for each item on the timeline.\n                    timeline.find('.annotation-timeline-item').draggable({\n                        'axis': 'x',\n                        'containment': '#annotation-timeline',\n                        'cursor': 'move',\n                        'grid': [1, 0],\n                        'start': function() {\n                            // Get all the selected elements.\n                            if (!$(this).hasClass('active')) {\n                                $(this).trigger('click');\n                            }\n                            let $selected = timeline.find('.annotation-timeline-item.active');\n                            $selected.addClass('no-pointer-events');\n                            $selected.each(function() {\n                                $(this).attr('data-startPosition', $(this).position());\n                            });\n                            timestampScrollbar($(this).attr('data-start'));\n                            $timelinewrapper.find('#timeline-items').addClass('no-pointer-events');\n                        },\n                        'drag': async function(e, ui) {\n                            let timestamp = (ui.position.left) / $('#annotation-timeline').width() * self.totaltime\n                                + self.start;\n                            let duration = $(this).attr('data-end') - $(this).attr('data-start');\n                            $('#s-position').text(convertSecondsToMMSS(timestamp));\n                            $('#e-position').text(convertSecondsToMMSS(timestamp + duration));\n\n                            // Hide or show these element\n                            let now = await self.player.getCurrentTime();\n                            let $annowrapper = $videoWrapper.find(`.annotation-wrapper[data-item=\"${$(this).attr('data-item')}\"]`);\n                            if (timestamp <= now && timestamp + duration >= now) {\n                                $annowrapper.css('visibility', 'visible');\n                            } else {\n                                $annowrapper.css('visibility', 'hidden');\n                            }\n                            let left = (timestamp - self.start) / self.totaltime * 100;\n                            $('#cursorbar').css('left', `calc(${left}% + 5px)`);\n                            $('#position-marker').css('left', `${left}%`);\n                            $('#vseek #bar #position').text(convertSecondsToMMSS(timestamp));\n\n                            let $selected = timeline.find('.annotation-timeline-item.active');\n                            const distance = ui.originalPosition.left - ui.position.left;\n                            $selected.not(this).each(function() {\n                                let $this = $(this);\n                                const position = $this.attr('data-startPosition');\n                                $this.css({\n                                    left: ((position.left - distance) / timeline.width()) * 100 + '%',\n                                });\n                                let timestamp = ($this.position().left / timeline.width()) * self.totaltime\n                                    + self.start;\n                                let duration = $this.attr('data-end') - $this.attr('data-start');\n                                let $annowrapper = $videoWrapper\n                                    .find(`.annotation-wrapper[data-item=\"${$this.attr('data-item')}\"]`);\n                                if (timestamp <= now && timestamp + duration >= now) {\n                                    $annowrapper.css('visibility', 'visible');\n                                } else {\n                                    $annowrapper.css('visibility', 'hidden');\n                                }\n                            });\n                        },\n                        'stop': function() {\n                            setTimeout(function() {\n                                $('#cursorbar, #position-marker').remove();\n                                $timelinewrapper.find('#timeline-items').removeClass('no-pointer-events');\n                                $(this).removeClass('no-pointer-events');\n                            }, 200);\n                            let $selected = $('.annotation-timeline-item.active');\n                            $selected.each(function() {\n                                let $this = $(this);\n                                let elementid = $this.attr('data-item');\n                                let itemIndex = items.findIndex(x => x.id == elementid);\n                                let item = items[itemIndex];\n                                let elem = $videoWrapper.find(`.annotation-wrapper[data-item=\"${elementid}\"]`);\n                                let prop = item.properties;\n                                let duration = prop.end - prop.start;\n                                prop.start = (($this.position().left) / timeline.width() * self.totaltime)\n                                    + self.start;\n                                prop.start = self.roundToTwo(prop.start);\n                                prop.end = prop.start + duration;\n                                elem.attr('data-start', prop.start);\n                                elem.attr('data-end', prop.end);\n                                $this.attr('data-start', prop.start);\n                                $this.attr('data-end', prop.end);\n                                item.properties = prop;\n                                items[itemIndex] = item;\n                            });\n                            $selected = $selected.map(function() {\n                                return $(this).attr('data-item');\n                            }).get();\n                            saveTracking($selected);\n                            renderItems(items, $selected, false);\n                        },\n                    });\n\n                    timeline.find('.annotation-timeline-item').resizable({\n                        'handles': 'e, w',\n                        'containment': 'parent',\n                        'grid': [1, 0],\n                        'start': async function() {\n                            // Get all the selected elements\n                            if (!$(this).hasClass('active')) {\n                                $(this).trigger('click');\n                            }\n                            let $selected = $('.annotation-timeline-item.active');\n                            $selected.addClass('no-pointer-events');\n                            $selected.each(function() {\n                                $(this).attr('data-originalStart', $(this).attr('data-start'));\n                                $(this).attr('data-originalEnd', $(this).attr('data-end'));\n                            });\n                            timestampScrollbar($(this).attr('data-start'));\n                            $timelinewrapper.find('#timeline-items').addClass('no-pointer-events');\n                        },\n                        'resize': async function(e, ui) {\n                            let timestamp = 0;\n                            if (ui.originalPosition.left != ui.position.left || ui.originalSize.width == ui.size.width) {\n                                if (ui.position.left < 0) {\n                                    ui.position.left = 0;\n                                }\n                                timestamp = ((ui.position.left)\n                                    / timeline.width()) * self.totaltime + self.start;\n                            } else {\n                                timestamp = ((ui.position.left + ui.size.width)\n                                    / timeline.width()) * self.totaltime + self.start;\n                            }\n\n                            let left = (timestamp - self.start) / self.totaltime * 100;\n                            $('#cursorbar').css('left', `calc(${left}% + 5px)`);\n                            $('#position-marker').css('left', `${left}%`);\n                            $('#vseek #bar #position').text(convertSecondsToMMSS(timestamp));\n\n                            const newStart = ((ui.position.left) / timeline.width()) * self.totaltime\n                                + self.start;\n                            let newEnd = ((ui.position.left + ui.size.width) / timeline.width())\n                                * self.totaltime + self.start;\n                            $('#s-position').text(convertSecondsToMMSS(newStart));\n                            $('#e-position').text(convertSecondsToMMSS(newEnd));\n\n                            // Hide or show this element\n                            let now = await self.player.getCurrentTime();\n                            let $annowrapper = $videoWrapper.find(`.annotation-wrapper[data-item=\"${$(this).attr('data-item')}\"]`);\n                            if (newStart <= now && newEnd >= now) {\n                                $annowrapper.css('visibility', 'visible');\n                            } else {\n                                $annowrapper.css('visibility', 'hidden');\n                            }\n\n                            // Handle other selected elements: same position and width\n                            let leftPercentage = ui.position.left / timeline.width() * 100;\n                            let newWidth = ui.size.width / timeline.width() * 100;\n                            let $selected = timeline.find('.annotation-timeline-item.active').not(this);\n                            $selected.each(function() {\n                                let $this = $(this);\n                                $this.css({\n                                    'left': leftPercentage + '%',\n                                    'width': newWidth + '%'\n                                });\n\n                                $this.attr('data-start', newStart);\n                                $this.attr('data-end', newEnd);\n                                let $annowrapper = $videoWrapper\n                                    .find(`.annotation-wrapper[data-item=\"${$this.attr('data-item')}\"]`);\n                                if (newStart <= now && newEnd >= now) {\n                                    $annowrapper.css('visibility', 'visible');\n                                } else {\n                                    $annowrapper.css('visibility', 'hidden');\n                                }\n                            });\n                        },\n                        'stop': async function(e, ui) {\n                            setTimeout(function() {\n                                $('#cursorbar, #position-marker').remove();\n                                $('#timeline-items').removeClass('no-pointer-events');\n                            }, 200);\n                            const newStart = ((ui.position.left) / timeline.width()) * self.totaltime\n                                + self.start;\n                            const newEnd = ((ui.position.left + ui.size.width) / timeline.width())\n                                * self.totaltime + self.start;\n                            let $selected = timeline.find('.annotation-timeline-item.active');\n                            $selected.each(function() {\n                                let $this = $(this);\n                                let elementid = $this.attr('data-item');\n                                let itemIndex = items.findIndex(x => x.id == elementid);\n                                let item = items[itemIndex];\n                                let elem = $videoWrapper.find(`.annotation-wrapper[data-item=\"${elementid}\"]`);\n                                let prop = item.properties;\n                                prop.start = self.roundToTwo(newStart);\n                                prop.end = self.roundToTwo(newEnd);\n                                let duration = prop.end - prop.start;\n                                if (prop.duration && prop.duration < duration) {\n                                    prop.end = prop.start + prop.duration;\n                                    // Correct the width.\n                                    $this.css('width', (prop.duration / self.totaltime) * 100 + '%');\n                                }\n                                elem.attr('data-start', prop.start);\n                                elem.attr('data-end', prop.end);\n                                $this.attr('data-start', prop.start);\n                                $this.attr('data-end', prop.end);\n                                item.properties = prop;\n                                items[itemIndex] = item;\n                            });\n                            $selected = $selected.map(function() {\n                                return $(this).attr('data-item');\n                            }).get();\n                            saveTracking($selected);\n                            renderItems(items, $selected, false);\n                        }\n                    });\n\n                    self.dispatchEvent('timeupdate', {time: currentTime});\n                    return true;\n                }\n                return true;\n            });\n        };\n\n        /**\n         * Append timestamp to the scrollbar.\n         * @param {Number} seconds\n         * @returns void\n         */\n        const timestampScrollbar = (seconds) => {\n            const formattedTime = convertSecondsToMMSS(seconds);\n            let $scrollbar = $('#scrollbar').clone();\n            $scrollbar.attr('id', 'cursorbar');\n            $scrollbar.find('#scrollhead').remove();\n            $('#timeline-items').append($scrollbar);\n            $('#vseek #bar').append(`<div id=\"position-marker\" class=\"border-0\">\n                <div id=\"position\" class=\"py-0 px-1\" style=\"top:-10px;\">\n                ${formattedTime}</div></div>`);\n        };\n\n        const renderImage = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = parts.length > 1 ? Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]) : -1;\n            if (prop.gotourl != '') {\n                wrapper.append(`<a href=\"${prop.gotourl}\" target=\"_blank\"><img src=\"${prop.url}\" id=\"${id}\"\n                         class=\"annotation-content w-100 ${prop.shadow == '1' ? 'shadow' : ''}\"\n                         ${prop.rounded == 1 ? 'style=\"border-radius:1em;\"' : ''} alt=\"${prop.formattedalttext}\"/></a>`);\n            } else {\n                wrapper.append(`<img src=\"${prop.url}\" id=\"${id}\"\n                              class=\"annotation-content w-100 ${prop.shadow == '1' ? 'shadow' : ''}\n                              ${timestamp > 0 ? 'cursor-pointer' : ''}\"\n                               ${prop.rounded == 1 ? 'style=\"border-radius:1em;\"' : ''} alt=\"${prop.formattedalttext}\"/>`);\n            }\n            if (!self.isEditMode()) {\n                if (prop.gotourl == '' && timestamp < 0) {\n                    wrapper.removeClass('resizable');\n                    wrapper.addClass('no-pointer');\n                } else {\n                    wrapper.addClass('clickable');\n                }\n                if (timestamp >= 0) {\n                    wrapper.attr('data-timestamp', timestamp);\n                }\n            }\n            wrapper.css(position);\n            wrapper.css('height', 'auto');\n            $videoWrapper.append(wrapper);\n        };\n\n        const renderVideo = (wrapper, item, prop, id, position) => {\n            const type = item.type;\n            const isAudio = !prop.url.endsWith('.mp4');\n            let srcType = isAudio ? 'audio' : 'video';\n            wrapper.append(`<${srcType} id=\"${id}\" class=\"${prop.muted == 1 ? 'muted' : ''} w-100\n                ${prop.shadow == 1 ? 'shadow' : ''}\" ${prop.muted == 1 ? 'muted' : ''}\n                preload=\"true\" src=\"${prop.url}\" style=\"overflow: hidden; border-radius: ${prop.rounded == 1 ? '1em' : '0'}\"\n                disablePictureInPicture/></${srcType}><div class=\"annotation-content w-100 h-100 position-absolute top-0\n                ${type == 'audio' ? 'bg-light' : ''}\"></div>`);\n            let video = wrapper.find(srcType)[0];\n            video.load(); // Have to preload.\n            video.playsInline = true;\n            if (!self.isEditMode() || $('#annotation-btns').length > 0) {\n                wrapper.find(srcType).addClass('no-pointer');\n                if (type == 'audio') {\n                    wrapper.find(srcType).addClass('invisible');\n                }\n            }\n            if (!self.isEditMode()) {\n                wrapper.find('.annotation-content').addClass('no-pointer invisible');\n                wrapper.addClass('no-pointer');\n                if (prop.dismissable == 1 && prop.size != '100' && type != 'audio') {\n                    wrapper.removeClass('no-pointer');\n                    wrapper.append(`<div class=\"dismiss-btn\">\n                        <i class=\"bi bi-x-lg\"></i></div>`);\n                }\n            }\n            wrapper.css(position);\n            if (type == 'audio') {\n                wrapper.css('opacity', '0.5');\n                wrapper.addClass('notresizable');\n            }\n            if (prop.freesize != 1) {\n                wrapper.addClass('notresizable');\n            }\n            $videoWrapper.append(wrapper);\n            recalculatingSize(wrapper);\n\n            // Adjust time to sync.\n            $(video).on('playing', async function() {\n                wrapper.removeClass('bg-light');\n                let t = await self.player.getCurrentTime();\n                let videoTime = video.currentTime + prop.start;\n                if (Math.abs(t - videoTime) > 0.5) {\n                    video.currentTime = t - prop.start;\n                }\n            });\n\n            $(video).on('waiting', async function() {\n                wrapper.addClass('bg-light');\n            });\n        };\n\n        const renderFile = async(wrapper, item, prop, id, position) => {\n            let wrapperhtml = ``;\n            const type = item.type;\n            if (type == 'file') {\n                wrapperhtml = `<a id=\"${id}\"\n                    class=\"btn ${prop.style} ${prop.rounded == '1' ? 'btn-rounded' : 'iv-rounded-0'}\n                    annotation-content text-nowrap ${prop.shadow == '1' ? 'shadow' : ''} rotatey-180\" href=\"${prop.url}\"\n                     target=\"_blank\"><i class=\"bi bi-paperclip fs-unset\"></i>${prop.formattedlabel != \"\" ?\n                        `<span style=\"margin-left:0.25em;\">${prop.formattedlabel}` : ''}</a>`;\n            } else if (type == 'mute') {\n                wrapperhtml = `<span id=\"${id}\" tabindex=\"0\" class=\"btn annotation-content text-nowrap`\n                // eslint-disable-next-line no-nested-ternary\n                + `${prop.hidden == '1' ? (self.isEditMode() ? 'opacity-50' : 'd-none') : ''}\">\n                <i class=\"bi bi-volume-mute fs-unset\"></i></span>`;\n            }\n            wrapper.append(`<div class=\"d-flex h-100\">${wrapperhtml}</div>`);\n            position.width = 0;\n            wrapper.css(position);\n            $videoWrapper.append(wrapper);\n            recalculatingTextSize(wrapper, true);\n        };\n\n        const renderNavigation = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n            wrapper.append(`<div class=\"d-flex h-100\"><span id=\"${id}\" tabindex=\"0\"\n                         class=\"btn ${prop.style} ${prop.rounded == '1' ? 'btn-rounded' : 'iv-rounded-0'}\n                          annotation-content text-nowrap ${prop.shadow == '1' ? 'shadow' : ''}\">\n                          ${prop.formattedlabel}</span></div>`);\n            position.width = 0;\n            wrapper.css(position);\n            $videoWrapper.append(wrapper);\n            if (!self.isEditMode()) {\n                wrapper.attr('data-timestamp', timestamp);\n            }\n            recalculatingTextSize(wrapper, true);\n        };\n\n        // Deprecated\n        const renderText = (wrapper, item, prop, id, position) => {\n            if (prop.url != undefined && prop.url != '') {\n                wrapper.append(`<a id=\"${id}\"\n                     class=\"annotation-content text-nowrap ${prop.shadow == '1' ? 'text-shadow' : ''} d-block\"\n                      href=\"${prop.url}\" target=\"_blank\">${prop.formattedlabel}</a>`);\n            } else {\n                if (!self.isEditMode() || !$('#content-region').hasClass('no-pointer-events')) {\n                    wrapper.addClass('no-pointer');\n                }\n                wrapper.append(`<div id=\"${id}\"\n                     class=\"annotation-content text-nowrap ${prop.shadow == '1' ? 'text-shadow' : ''}\n                     \">${prop.formattedlabel}</div>`);\n            }\n            wrapper.position.width = 0;\n            wrapper.css(position);\n            const style = {\n                'font-weight': prop.bold == '1' ? 'bold' : 'normal',\n                'font-style': prop.italic == '1' ? 'italic' : 'normal',\n                'text-decoration': prop.underline == '1' ? 'underline' : 'none',\n                'color': prop.textcolor,\n                'background': prop.bgcolor,\n                'border-width': prop.borderwidth,\n                'border-color': prop.bordercolor,\n                'border-style': 'solid',\n                'font-family': prop.textfont != '' ? prop.textfont : 'inherit',\n            };\n            wrapper.find('.annotation-content').css(style);\n            $videoWrapper.append(wrapper);\n            recalculatingTextSize(wrapper);\n        };\n\n        const renderTextBlock = (wrapper, item, prop, id, position) => {\n            let textparts = prop.formattedlabel.split('\\r\\n');\n            let textblock = '<div class=\"d-flex flex-column\">';\n            const timestamp = prop.timestamp.split(':');\n            const time = timestamp.length > 1 ? Number(timestamp[0]) * 3600 + Number(timestamp[1]) * 60 + Number(timestamp[2])\n                : -1;\n            textparts.forEach((part) => {\n                if (part.trim() == '') {\n                    return;\n                }\n                textblock += `<span class=\"text-row text-nowrap iv-text-${prop.alignment}\"\n                         style='font-family: ${prop.textfont != '' ? prop.textfont : 'inherit'}'>\n                         ${part}</span>`;\n            });\n            textblock += '</div>';\n            if (prop.url != undefined && prop.url != '') {\n                wrapper.append(`<a id=\"${id}\"\n                             class=\"annotation-content d-block ${prop.shadow == '1' ? 'text-shadow' : ''}\"\n                              href=\"${prop.url}\" target=\"_blank\">${textblock}</a>`);\n                wrapper.addClass('clickable');\n            } else {\n                if (!self.isEditMode() || !$('#content-region').hasClass('no-pointer-events')) {\n                    if (time >= 0) {\n                        wrapper.addClass('cursor-pointer');\n                    } else {\n                        wrapper.addClass('no-pointer');\n                    }\n                }\n                wrapper.append(`<div id=\"${id}\"\n                             class=\"annotation-content ${prop.shadow == '1' ? 'text-shadow' : ''}\">${textblock}</div>`);\n\n                if (time >= 0) {\n                    wrapper.attr('data-timestamp', time);\n                }\n            }\n            wrapper.position.width = 0;\n            wrapper.css(position);\n            const style = {\n                'font-size': item.position.fontSize,\n                'line-height': item.position.lineHeight,\n                'font-weight': prop.bold == '1' ? 'bold' : 'normal',\n                'font-style': prop.italic == '1' ? 'italic' : 'normal',\n                'text-decoration': prop.underline == '1' ? 'underline' : 'none',\n                'color': prop.textcolor,\n                'background': prop.bgcolor,\n                'border-radius': prop.rounded == '1' ? '0.3em' : '0',\n                'border-width': prop.borderwidth,\n                'border-color': prop.bordercolor,\n                'border-style': 'solid',\n            };\n            wrapper.find('.annotation-content').css(style);\n            $videoWrapper.append(wrapper);\n            recalculatingTextSize(wrapper, false, true);\n        };\n\n        const renderShape = (wrapper, item, prop, id, position) => {\n            const parts = prop.timestamp.split(':');\n            const timestamp = parts.length > 1 ? Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]) : -1;\n            if (prop.gotourl != '') {\n                wrapper.append(`<a href=\"${prop.gotourl}\" target=\"_blank\"><div id=\"${id}\"\n                         class=\"annotation-content ${prop.shadow == '1' ? 'shadow' : ''}\"\n                          style=\"width: 100%; height: 100%;\"></div></a>`);\n                wrapper.addClass('clickable');\n            } else {\n                if (!self.isEditMode()) {\n                    if (timestamp < 0) {\n                        wrapper.addClass('no-pointer');\n                    } else {\n                        wrapper.addClass('clickable');\n                    }\n                }\n                wrapper.append(`<div id=\"${id}\" class=\"annotation-content ${prop.shadow == '1' ? 'shadow' : ''}\"\n                         style=\"width: 100%; height: 100%;\"></div>`);\n                if (timestamp >= 0) {\n                    wrapper.attr('data-timestamp', timestamp);\n                }\n            }\n            wrapper.css(position);\n            const style = {\n                'background': prop.bgcolor,\n                'border-width': prop.borderwidth,\n                'border-color': prop.bordercolor,\n                'border-style': 'solid',\n                'opacity': prop.opacity / 100,\n            };\n            if (prop.shape == 'circle') {\n                style['border-radius'] = '50%';\n            } else if (prop.shape == 'rectangle') {\n                style['border-radius'] = prop.rounded == '1' ? '1em' : '0';\n            }\n            wrapper.find('.annotation-content').css(style);\n            $videoWrapper.append(wrapper);\n        };\n\n        const renderHotspot = (wrapper, item, prop, id, position) => {\n            wrapper.append(`<div id=\"${id}\" class=\"annotation-content shadow-sm pulse\" role=\"button\"\n                title=\"${prop.formattedtitle}\"></div>`);\n            position['aspect-ratio'] = '1';\n            wrapper.css(position);\n            const style = {\n                'background-color': prop.color,\n                'opacity': prop.opacity / 100,\n                'border-radius': '50%',\n                'aspect-ratio': '1',\n            };\n            wrapper.find('.annotation-content').css(style);\n            $videoWrapper.append(wrapper);\n\n            if (!self.isEditMode()) {\n                if (prop.usemodal == '1') {\n                    if (self.isBS5) {\n                        wrapper.attr({\n                            'data-bs-toggle': 'modal',\n                        });\n                    } else {\n                        wrapper.attr({\n                            'data-toggle': 'modal',\n                        });\n                    }\n                } else {\n                    let attr = {\n                        'tabindex': -1,\n                    };\n                    if (self.isBS5) {\n                        attr['data-bs-trigger'] = 'manual';\n                        attr['data-bs-boundary'] = 'viewport';\n                        attr['data-bs-placement'] = 'auto';\n                        attr['data-bs-html'] = 'true';\n                        attr['data-bs-content'] = '<div class=\"loader\"></div>';\n                        attr['data-bs-title'] = prop.formattedtitle\n                            + `<i class=\"bi bi-x-circle-fill iv-ml-auto popover-dismiss cursor-pointer\"\n                                     style=\"font-size:1.5em;\"></i>`;\n                    } else {\n                        attr['data-trigger'] = 'manual';\n                        attr['data-boundary'] = 'viewport';\n                        attr['data-placement'] = 'auto';\n                        attr['data-html'] = 'true';\n                        attr['data-content'] = '<div class=\"loader\"></div>';\n                        attr['data-title'] = prop.formattedtitle\n                            + `<i class=\"bi bi-x-circle-fill iv-ml-auto popover-dismiss cursor-pointer\"\n                                     style=\"font-size:1.5em;\"></i>`;\n                    }\n\n                    wrapper.attr(attr);\n\n                    wrapper.popover({\n                        container: '#wrapper',\n                        html: true,\n                        template: `<div class=\"popover inlineannotation-popover id-${id}\"\n                                 role=\"tooltip\"><div class=\"arrow\"></div>\n                                 <h3 class=\"popover-header d-flex justify-content-between\"></h3>\n                                 <div class=\"popover-body rounded\"></div>${prop.url != '' ?\n                                `<div class=\"popup-footer bg-light p-2 rounded-bottom\"><a href=\"${prop.url}\"\n                                      class=\"d-block w-100 iv-text-right rotatex-360\" target=\"_blank\">\n                                      <i class=\"bi bi-arrow-right\"><i></i></i></a></div>` : ''}</div>`,\n                    });\n\n                    wrapper.on('shown.bs.popover', async function() {\n                        let $body = $(`.popover.id-${id} .popover-body`);\n                        const html = await self.formatContent(prop.content.text, annotation.contextid);\n                        $body.html(html);\n                        notifyFilter($body);\n                        wrapper.popover('update');\n                    });\n                    if (prop.openbydefault == '1') {\n                        wrapper.popover('show');\n                    }\n                }\n            }\n        };\n\n        const renderLink = (wrapper, item, prop, id, position) => {\n            wrapper.append(`<a href=\"${prop.url}\" target=\"_blank\" class=\"text-decoration-none\" title=\"${prop.formattedlabel}\">\n                <div id=\"${id}\" class=\"annotation-content text-nowrap text-truncate\">\n                ${prop.icon != '' ? `<i class=\"${prop.icon} fs-unset iv-mr-1\"></i>` : ''}\n                ${prop.formattedlabel}</div>\n                </a>`);\n            wrapper.css(position);\n            wrapper.attr({\n                'data-position': prop.position,\n                'data-color': prop.color,\n            });\n            if ($videoWrapper.outerWidth() > 1000) {\n                wrapper.find('a').css({\n                    'font-size': '16px',\n                });\n            }\n            $videoWrapper.append(wrapper);\n        };\n\n        const renderMessage = (wrapper, item, prop, id, position) => {\n            wrapper.append(`<${prop.url != '' ? `a href=\"${prop.url}\" target=\"_blank\" ` : 'div'}\n                 class=\"text-decoration-none message-wrapper p-3\"\n                 title=\"${prop.formattedtitle}\">\n                <div id=\"${id}\" class=\"annotation-content d-flex\">\n                ${prop.icon != '' ? `<i class=\"${prop.icon} iv-mr-2\"></i>` : ''}\n                <div>\n                ${prop.formattedtitle ? `<div class=\"iv-font-weight-bold mb-1\">${prop.formattedtitle}</div>` : ''}\n                <div class=\"small\">${prop.formatteddesc}</div>\n                </div></div>\n                ${prop.url != '' ? `<i class=\"bi bi-arrow-up-right fs-unset link-icon\"></i>` : ''}\n                <i class=\"bi bi-pause-fill message-pause fs-25px\"></i>\n                ${prop.url != '' ? `</a>` : '</div>'}`);\n            wrapper.css(position);\n            wrapper.attr({\n                'data-position': prop.position,\n                'data-color': prop.color,\n                'data-viewport': prop.viewport,\n            });\n            if ($videoWrapper.outerWidth() > 1000) {\n                wrapper.find('.message-wrapper').css({\n                    'font-size': '16px',\n                });\n            }\n            $videoWrapper.append(wrapper);\n        };\n\n        /**\n         * Render items on the annotation canvas.\n         * @param {Array} elements array of elements to render\n         * @param {Array} actives ids of active element\n         * @param {Boolean} update first render or updating items\n         */\n        const renderItems = async(elements, actives, update) => {\n            const currentTime = await self.player.getCurrentTime();\n            if (!update) { // Clear the annotation-canvas if it is a new start.\n                $videoWrapper.find(`.annotation-wrapper`).remove();\n                $('#timeline #annotation-timeline').empty();\n            }\n\n            if (elements.length == 0) {\n                if (actives) {\n                    actives.forEach((active) => {\n                        $videoWrapper.find(`.annotation-wrapper[data-item=\"${active}\"]`).addClass('active');\n                        setTimeout(function() {\n                            $('#timeline #annotation-timeline').find(`.annotation-timeline-item[data-item=\"${active}\"]`)\n                                .addClass('active');\n                        }, 200);\n                    });\n                }\n            } else {\n                // Sort element by z-index.\n                elements.sort((a, b) => Number(b.position['z-index']) - Number(a.position['z-index']));\n                elements = elements.filter(item => item.properties.start <= self.end && item.properties.end >= self.start);\n                elements.map(async item => {\n                    let start = item.properties.start;\n                    let end = item.properties.end;\n                    if (start < self.start) {\n                        start = self.start;\n                    }\n                    if (end > self.end) {\n                        end = self.end;\n                    }\n\n                    // Correct the time if the item is video. Make sure the total duration is not more than the video duration.\n                    if (item.type == 'video' || item.type == 'audio') {\n                        let duration = end - start;\n                        await new Promise(resolve => {\n                            let video = document.createElement(item.type);\n                            video.src = item.properties.url;\n                            video.onloadedmetadata = function() {\n                                let videoDuration = video.duration;\n                                if (duration > videoDuration) {\n                                    end = start + videoDuration;\n                                }\n                                item.properties.duration = videoDuration;\n                                // Remove the video element after getting the duration.\n                                video.remove();\n                                resolve();\n                            };\n                        });\n                    }\n\n                    item.properties.start = start;\n                    item.properties.end = end;\n\n                    return item;\n                });\n\n                let count = 0;\n                elements.forEach(async(item) => {\n                    let prop = item.properties;\n                    let type = item.type;\n                    let id = item.id;\n                    let position = item.position;\n                    let wrapper = $(`<div class=\"annotation-wrapper\" data-group=\"${position.group}\"\n                         data-start=\"${self.roundToTwo(prop.start)}\"\n                         data-duration=\"${self.roundToTwo(prop.duration)}\"\n                     data-end=\"${self.roundToTwo(prop.end)}\"  data-anno=\"${annotation.id}\" data-item=\"${id}\"\n                      data-type=\"${type}\"></div>`);\n                    if (prop.resizable == '1' || self.isEditMode()) {\n                        wrapper.addClass('resizable');\n                        wrapper.attr('tabindex', 0);\n                    }\n                    // Correct the position in player mode.\n                    if (!self.isEditMode()) {\n                        const left = position.left.replace('%', '');\n                        const top = position.top.replace('%', '');\n                        const width = position.width.replace('%', '');\n                        const height = position.height ? position.height.replace('%', '') : 0;\n                        if (left < 0.01) {\n                            position.left = '0%';\n                        }\n                        if (top < 0.01) {\n                            position.top = '0%';\n                        }\n                        if (width > 99.5) {\n                            position.width = '100%';\n                        }\n                        if (height > 99.5) {\n                            position.height = '100%';\n                        }\n                    }\n                    switch (type) {\n                        case 'image':\n                            renderImage(wrapper, item, prop, id, position);\n                            break;\n                        case 'file':\n                        case 'mute':\n                            renderFile(wrapper, item, prop, id, position);\n                            break;\n                        case 'navigation':\n                            renderNavigation(wrapper, item, prop, id, position);\n                            break;\n                        case 'text':\n                            renderText(wrapper, item, prop, id, position);\n                            break;\n                        case 'textblock':\n                            renderTextBlock(wrapper, item, prop, id, position);\n                            break;\n                        case 'shape':\n                            renderShape(wrapper, item, prop, id, position);\n                            break;\n                        case 'hotspot':\n                            renderHotspot(wrapper, item, prop, id, position);\n                            break;\n                        case 'video':\n                        case 'audio':\n                            renderVideo(wrapper, item, prop, id, position);\n                            break;\n                        case 'link':\n                            renderLink(wrapper, item, prop, id, position);\n                            break;\n                        case 'message':\n                            renderMessage(wrapper, item, prop, id, position);\n                            break;\n                    }\n\n                    if (type != 'shape') {\n                        wrapper.off('mouseover.Annotation');\n                        wrapper.on('mouseover.Annotation', function() {\n                            if (!$(this).hasClass('resizable')) {\n                                return;\n                            }\n\n                            let aspectRatio =\n                                $(this).find('.annotation-content').width() / $(this).find('.annotation-content').height();\n                            if (type == 'video') {\n                                aspectRatio = $(this).find('video')[0].videoWidth / $(this).find('video')[0].videoHeight;\n                            }\n                            if (wrapper.width() / wrapper.height() != aspectRatio && (type == 'image' || type == 'video')) {\n                                $(this).height((wrapper.width() / aspectRatio));\n                            }\n                            try {\n                                $(this).resizable('option', 'aspectRatio', $(this).find('.annotation-content').outerWidth() /\n                                    $(this).find('.annotation-content').outerHeight());\n                            } catch (e) {\n                                // Do nothing.\n                            }\n                        });\n                    }\n\n                    count++;\n\n                    if (count == elements.length) {\n                        $('.annotation-wrapper').css('visibility', 'hidden');\n                        // Always trigger the timeupdate event after all items are rendered.\n                        self.dispatchEvent('timeupdate', {time: self.roundToTwo(currentTime)});\n\n                        if (self.isEditMode()) {\n                            if ($('#annotation-btns').is(\":visible\") == false) {\n                                $videoWrapper.find('.annotation-wrapper').addClass('no-pointer');\n                            }\n                            // Initialize the draggable and resizable for each item.\n                            $videoWrapper.find('.annotation-wrapper:not(.notresizable)').draggable({\n                                containment: \"#annotation-canvas\",\n                                cursor: \"move\",\n                                grid: [1, 1],\n                                handle: '.annotation-content',\n                                start: function() {\n                                    getItems(false);\n                                    // Get all the selected elements\n                                    if (!$(this).hasClass('active')) {\n                                        $(this).trigger('click');\n                                    }\n                                    let $selected = $videoWrapper.find('.annotation-wrapper.active');\n                                    $selected.addClass('no-pointer');\n                                    $selected.each(function() {\n                                        $(this).attr('data-startPosition', $(this).position());\n                                    });\n                                },\n                                drag: function(event, ui) {\n                                    let $selected = $videoWrapper.find('.annotation-wrapper.active');\n                                    let left = ui.originalPosition.left - ui.position.left;\n                                    let top = ui.originalPosition.top - ui.position.top;\n                                    let positions = $selected.map(function() {\n                                        return {\n                                            id: $(this).attr('data-item'),\n                                            left: $(this).position().left,\n                                            top: $(this).position().top,\n                                            bottom: $(this).position().top + $(this).height(),\n                                            right: $(this).position().left + $(this).width(),\n                                        };\n                                    }).get();\n\n                                    if (positions.find(x => x.left < 0)) {\n                                        // Sort the elements by left position to get the leftmost element\n                                        positions.sort((a, b) => a.left - b.left);\n                                        let onLeft = positions.find(x => x.left < 0);\n                                        let id = onLeft.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('left', 0);\n                                        let distance = target.attr('data-startPosition').left;\n                                        ui.position.left = ui.originalPosition.left - distance;\n                                        left = ui.originalPosition.left - ui.position.left;\n                                    }\n\n                                    if (positions.find(x => x.top < 0)) {\n                                        positions.sort((a, b) => a.top - b.top);\n                                        let onTop = positions.find(x => x.top < 0);\n                                        let id = onTop.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('top', 0);\n                                        let distance = target.attr('data-startPosition').top;\n                                        ui.position.top = ui.originalPosition.top - distance;\n                                        top = ui.originalPosition.top - ui.position.top;\n                                    }\n\n                                    if (positions.find(x => x.right > $('#annotation-canvas').width())) {\n                                        positions.sort((a, b) => a.right - b.right);\n                                        let onRight = positions.find(x => x.right > $('#annotation-canvas').width());\n                                        let id = onRight.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('left', ($('#annotation-canvas').width() - target.width() - 1) + 'px');\n                                        let distance = target.attr('data-startPosition').left - target.position().left;\n                                        ui.position.left = ui.originalPosition.left - distance;\n                                        left = ui.originalPosition.left - ui.position.left;\n                                    }\n\n                                    if (positions.find(x => x.bottom > $('#annotation-canvas').height())) {\n                                        positions.sort((a, b) => a.bottom - b.bottom);\n                                        let onBottom = positions.find(x => x.bottom > $('#annotation-canvas').height());\n                                        let id = onBottom.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('top', ($('#annotation-canvas').height() - target.height() - 1) + 'px');\n                                        let distance = target.attr('data-startPosition').top - target.position().top;\n                                        ui.position.top = ui.originalPosition.top - distance;\n                                        top = ui.originalPosition.top - ui.position.top;\n                                    }\n\n                                    $selected.not(this).each(function() {\n                                        let $this = $(this);\n                                        let position = $this.attr('data-startPosition');\n                                        $this.css({\n                                            left: (position.left - left) + 'px',\n                                            top: (position.top - top) + 'px',\n                                        });\n                                    });\n                                    updatePositionInfo($(this));\n                                },\n                                stop: function() {\n                                    let $selected = $videoWrapper.find('.annotation-wrapper.active');\n                                    let positions = $selected.map(function() {\n                                        return {\n                                            id: $(this).attr('data-item'),\n                                            left: $(this).position().left,\n                                            top: $(this).position().top,\n                                            bottom: $(this).position().top + $(this).height(),\n                                            right: $(this).position().left + $(this).width(),\n                                        };\n                                    }).get();\n\n                                    if (positions.find(x => x.left < 0)) {\n                                        positions.sort((a, b) => a.left - b.left);\n                                        let onLeft = positions.find(x => x.left < 0);\n                                        let id = onLeft.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('left', 0);\n                                        let distance = target.attr('data-startPosition').left;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.attr('data-startPosition');\n                                            let newLeft = position.left - distance;\n                                            $this.css('left', newLeft + 'px');\n                                        });\n                                    }\n\n                                    if (positions.find(x => x.top < 0)) {\n                                        positions.sort((a, b) => a.top - b.top);\n                                        let onTop = positions.find(x => x.top < 0);\n                                        let id = onTop.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('top', 0);\n                                        let distance = target.attr('data-startPosition').top;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.attr('data-startPosition');\n                                            let newTop = position.top - distance;\n                                            $this.css('top', newTop + 'px');\n                                        });\n                                    }\n\n                                    if (positions.find(x => x.right > $('#annotation-canvas').width())) {\n                                        positions.sort((a, b) => a.right - b.right);\n                                        let onRight = positions.find(x => x.right > $('#annotation-canvas').width());\n                                        let id = onRight.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('left', ($('#annotation-canvas').width() - target.width() - 1) + 'px');\n                                        let distance = target.attr('data-startPosition').left - target.position().left;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.attr('data-startPosition');\n                                            let newLeft = position.left - distance;\n                                            $this.css('left', newLeft + 'px');\n                                        });\n                                    }\n\n                                    if (positions.find(x => x.bottom > $('#annotation-canvas').height())) {\n                                        positions.sort((a, b) => a.bottom - b.bottom);\n                                        let onBottom = positions.find(x => x.bottom > $('#annotation-canvas').height());\n                                        let id = onBottom.id;\n                                        let target = $videoWrapper.find(`.annotation-wrapper[data-item=\"${id}\"]`);\n                                        target.css('top', ($('#annotation-canvas').height() - target.height() - 1) + 'px');\n                                        let distance = target.attr('data-startPosition').top - target.position().top;\n                                        $selected.each(function() {\n                                            let $this = $(this);\n                                            let position = $this.attr('data-startPosition');\n                                            let newTop = position.top - distance;\n                                            $this.css('top', newTop + 'px');\n                                        });\n                                    }\n\n                                    getItems(false);\n                                    $selected = $selected.map(function() {\n                                        return $(this).attr('data-item');\n                                    }).get();\n                                    saveTracking($selected);\n                                    if ($selected.length == 1) {\n                                        $(this).trigger('click');\n                                    }\n                                    $videoWrapper.find('.annotation-wrapper').removeClass('no-pointer');\n                                }\n                            });\n\n                            $videoWrapper.find('.annotation-wrapper:not(.notresizable)').resizable({\n                                containment: \"#annotation-canvas\",\n                                handles: \"all\",\n                                grid: [1, 1],\n                                minHeight: 1,\n                                minWidth: 1,\n                                resize: function(event) {\n                                    let type = $(this).attr('data-type');\n                                    if (type == 'file' || type == 'navigation' || type == 'textblock'\n                                        || type == 'mute') {\n                                        recalculatingTextSize($(this), type != 'textblock', type == 'textblock');\n                                    } else if (type == 'shape' && event.ctrlKey) {\n                                        $(this).resizable('option', 'aspectRatio', 1);\n                                    }\n                                    updatePositionInfo($(this));\n                                },\n                                stop: function() {\n                                    let type = $(this).attr('data-type');\n                                    if (type == 'file' || type == 'navigation' || type == 'textblock'\n                                        || type == 'mute') {\n                                        recalculatingTextSize($(this), type != 'textblock', type == 'textblock');\n                                    } else if (type == 'shape') {\n                                        $(this).resizable('option', 'aspectRatio', false);\n                                    }\n                                    recalculatingSize($(this));\n                                    getItems(false);\n                                    saveTracking([$(this).attr('data-item')]);\n                                    $(this).trigger('click');\n                                }\n                            });\n\n                            await renderTimelineItems(elements, actives);\n                            self.dispatchEvent('timeupdate', {time: self.roundToTwo(currentTime)});\n                            self.dispatchEvent('annotationChanged');\n                        }\n                    }\n\n                    if (actives && actives.includes(id)) {\n                        wrapper.addClass('active');\n                        if (actives.length == 1) {\n                            setTimeout(function() {\n                                wrapper.trigger('mouseover');\n                                wrapper.trigger('click');\n                            }, 500);\n                        }\n                    }\n                });\n\n                // Handle behavior for each item\n                if (!self.isEditMode()) {\n                    $videoWrapper.off('click', `.annotation-wrapper`).on('click', `.annotation-wrapper`, async function(e) {\n                        e.stopImmediatePropagation();\n                        let wrapper = $(this);\n                        let type = wrapper.attr('data-type');\n                        switch (type) {\n                            case 'message':\n                                await self.player.pause();\n                                break;\n                            case 'hotspot':\n                                await self.player.pause();\n                                var hotspotid = wrapper.attr('data-item');\n                                var hotspot = items.find(x => x.id == hotspotid);\n                                var viewertype = wrapper.attr('data-toggle') || wrapper.attr('data-bs-toggle');\n                                if (viewertype == 'modal') {\n                                    let title = hotspot.properties.formattedtitle;\n                                    let content = hotspot.properties.content.text;\n                                    let url = hotspot.properties.url;\n                                    let modal = `<div class=\"modal fade\" id=\"annotation-modal\" role=\"dialog\"\n                                aria-labelledby=\"annotation-modal\"\n                             aria-hidden=\"true\" data${self.isBS5 ? '-bs' : ''}-backdrop=\"static\"\n                              data${self.isBS5 ? '-bs' : ''}-keyboard=\"false\">\n                             <div class=\"modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable\" role=\"document\">\n                                <div class=\"modal-content iv-rounded-lg\">\n                                    <div class=\"modal-header d-flex align-items-center shadow-sm iv-iv-pr-0\" id=\"title\">\n                                        <h5 class=\"modal-title text-truncate mb-0\">${title}</h5>\n                                        <button class=\"btn mx-2 p-0 close\" aria-label=\"Close\"\n                                         data${self.isBS5 ? '-bs' : ''}-dismiss=\"modal\">\n                                            <i class=\"bi bi-x-lg fa-fw\" style=\"font-size: x-large;\"></i>\n                                        </button>\n                                    </div>\n                                    <div class=\"modal-body\" id=\"content\">\n                                    <div class=\"loader\"></div>\n                                    </div>\n                                    ${url != '' ? `<div class=\"modal-footer bg-light p-2 rounded-bottom\">\n                                        <a href=\"${url}\" class=\"d-block w-100 iv-text-right rotatex-360\" target=\"_blank\">\n                                        <i class=\"bi bi-arrow-right\"><i></i></i></a></div>` : ''}\n                                    </div>\n                                </div>\n                                </div>`;\n                                    $('#wrapper').append(modal);\n                                    $('#annotation-modal').modal('show');\n                                    $('#annotation-modal').on('hide.bs.modal', function() {\n                                        $('#annotation-modal').remove();\n                                    });\n                                    $('#annotation-modal').on('shown.bs.modal', async function() {\n                                        $('#annotation-modal .modal-body').fadeIn(300);\n                                        let $body = $('#annotation-modal .modal-body');\n                                        const html = await self.formatContent(content, annotation.contextid);\n                                        $body.html(html);\n                                        notifyFilter($body);\n                                    });\n                                } else {\n                                    wrapper.popover('show');\n                                }\n                                break;\n                        }\n\n                        if ($(this).attr('data-timestamp') != undefined) {\n                            let timestamp = $(this).attr('data-timestamp');\n                            self.player.seek(timestamp);\n                            self.player.play();\n                        }\n                    });\n\n                    $playerWrapper.off('click', `.popover-dismiss`).on('click', `.popover-dismiss`, function(e) {\n                        e.stopImmediatePropagation();\n                        $(this).closest('.popover').remove();\n                    });\n                }\n            }\n        };\n\n        // Check resize on video wrapper resize\n        let vwrapper = document.querySelector('#video-wrapper');\n        let resizeTimeout;\n        let resizeObserver = new ResizeObserver(() => {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(() => {\n                let existingwrapper = $(`#annotation-canvas`).find(`.annotation-wrapper`);\n                if (existingwrapper.length === 0) {\n                    return;\n                }\n                existingwrapper.each(function() {\n                    let wrapper = $(this);\n                    let type = wrapper.attr('data-type');\n                    if (type === 'file' || type === 'navigation' || type === 'textblock' || type === 'mute') {\n                        recalculatingTextSize(wrapper, type !== 'textblock', type === 'textblock');\n                    } else if (type === 'video') {\n                        recalculatingSize(wrapper);\n                        let $annotationContent = wrapper.find('.annotation-content');\n                        let aspectRatio = $annotationContent.width() / $annotationContent.height();\n                        if (wrapper.width() / wrapper.height() !== aspectRatio) {\n                            wrapper.height(wrapper.width() / aspectRatio);\n                        }\n                    }\n                });\n                $('#annotation-canvas').css('font-size', $('#annotation-canvas').width() / 75 + 'px');\n            }, 100);\n        });\n        resizeObserver.observe(vwrapper);\n\n        // Ready to render items.\n\n        let items = [];\n        let tracking = [];\n        let trackingIndex = 0;\n        if (data.items != '' && data.items !== null) {\n            items = JSON.parse(data.items);\n            tracking.push({\n                items: JSON.stringify(items),\n                actives: null,\n                timestamp: self.start,\n            });\n        }\n        let draftitemid = data.draftitemid;\n\n        await renderItems(items, null, false);\n\n        // End of view mode.\n        if (!self.isEditMode()) {\n            return;\n        }\n\n        /**\n         * Update tracking data for redo and undo\n         * @param {Array} actives array of active items\n         */\n        const saveTracking = (actives) => {\n            if (trackingIndex < tracking.length - 1) {\n                // Remove all the tracking data after the current index.\n                tracking = tracking.slice(0, trackingIndex + 1);\n            }\n            tracking.push({\n                items: JSON.stringify(items),\n                actives: actives,\n                timestamp: self.player.getCurrentTime(),\n                at: new Date().getTime(),\n            });\n            tracking.sort((a, b) => a.at - b.at);\n            trackingIndex = tracking.length - 1;\n            $('#annotation-btns #undo').removeAttr('disabled');\n            $('#annotation-btns #redo').attr('disabled', 'disabled');\n            if (tracking.length == 1) {\n                $('#annotation-btns #undo').attr('disabled', 'disabled');\n            }\n        };\n\n        /**\n         * Order items by layer.\n         * @param {Array} ids array of item ids\n         * @param {String} order asc or desc\n         * @returns {Array} sorted array of item ids\n         */\n        const sortItemsByLayer = (ids, order) => {\n            ids = ids.map(x => x.toString()); // Convert ids to string for consistency.\n            let targetItems = items.filter(item => {\n                const id = item.id.toString();\n                return ids.includes(id);\n            });\n            if (order == 'desc') {\n                targetItems.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n            } else {\n                targetItems.sort((a, b) => a.position['z-index'] - b.position['z-index']);\n            }\n\n            return targetItems.map(item => item.id);\n        };\n\n        /**\n         * Get highest z-index.\n         * @param {Array} itms array of items\n         * @returns {Number} top z-index\n         */\n        const getTopLayer = (itms) => {\n            if (itms.length == 0) {\n                return 5;\n            }\n            let ids = itms.map(item => item.id);\n            let sorted = sortItemsByLayer(ids, 'desc');\n            let zindex = itms.find(item => item.id == sorted[0]).position['z-index'];\n            return Number(zindex);\n        };\n\n        /**\n         * Get lowest z-index.\n         * @param {Array} itms array of items\n         * @returns {Number} bottom z-index\n         */\n        const getBottomLayer = (itms) => {\n            if (itms.length == 0) {\n                return 5;\n            }\n            let ids = itms.map(item => item.id);\n            let sorted = sortItemsByLayer(ids, 'asc');\n            let zindex = itms.find(item => item.id == sorted[0]).position['z-index'];\n            return Number(zindex);\n        };\n\n        /**\n         * Get all items from the annotation-canvas.\n         * @param {Boolean} updateid whether or not to update the id of the item.\n         */\n        const getItems = (updateid) => {\n            let newItems = [];\n            const annos = $videoWrapper.find(`.annotation-wrapper`);\n            annos.each(function(index, element) {\n                const id = $(element).attr('data-item');\n                let item = {\n                    \"type\": $(element).attr('data-type'),\n                    \"position\": recalculatingSize($(element)),\n                };\n                item.id = id;\n                item.properties = items.find(x => x.id == id).properties;\n                if (updateid) {\n                    item.id = new Date().getTime() + index;\n                    $(element).attr('data-item', item.id);\n                }\n                newItems.push(item);\n            });\n            items = newItems;\n            draftStatus = 'draft';\n        };\n\n        /**\n         * Handle form data when adding or editing an item.\n         * @param {Object} newItem data from form submission\n         * @param {String} type type of the item\n         * @param {Boolean} add adding or editing\n         */\n        const handleFormData = async(newItem, type, add) => {\n            switch (type) {\n                case 'file':\n                    if (add) {\n                        newItem.position.height = '40px';\n                        newItem.position.width = '130px';\n                    }\n                    break;\n                case 'textblock':\n                    if (add) {\n                        newItem.position.fontSize = '16px';\n                        newItem.position.lineHeight = '20px';\n                    }\n                    break;\n                case 'shape':\n                    if (add) {\n                        newItem.position.height = '100px';\n                        newItem.position.width = '100px';\n                    }\n                    break;\n                case 'mute':\n                    if (add) {\n                        newItem.position.height = '40px';\n                        newItem.position.width = '40px';\n                    }\n                    break;\n                case 'video':\n                case 'audio':\n                    await new Promise(resolve => {\n                        // Check duration of the video.\n                        var thisvideo = document.createElement('video');\n                        thisvideo.src = newItem.properties.url;\n                        thisvideo.onloadedmetadata = function() {\n                            let videoDuration = thisvideo.duration;\n                            newItem.properties.duration = videoDuration;\n                            newItem.properties.width = thisvideo.videoWidth;\n                            newItem.properties.height = thisvideo.videoHeight;\n                            if (add) {\n                                newItem.properties.end = newItem.properties.start + videoDuration;\n                            } else {\n                                if (newItem.properties.end > newItem.properties.start + videoDuration) {\n                                    newItem.properties.end = newItem.properties.start + videoDuration;\n                                }\n                            }\n                            // Remove the video element after getting the duration.\n                            thisvideo.remove();\n                            resolve();\n                        };\n                    });\n                    if (type == 'video') {\n                        newItem.position.height = 'auto';\n                        // Video wrapper width and height.\n                        let videoWidth = $(`#annotation-canvas`).width();\n                        let videoHeight = $(`#annotation-canvas`).height();\n                        if (newItem.properties.freesize != 1) {\n                            let vwidth = videoWidth * newItem.properties.size / 100;\n                            let vheight = vwidth * newItem.properties.height / newItem.properties.width;\n                            newItem.position.width = vwidth + 'px';\n                            newItem.position.height = vheight + 'px';\n                            let padding = vwidth * 0.05;\n                            if (newItem.properties.size == '100') {\n                                newItem.position.width = '100%';\n                                newItem.position.height = '100%';\n                                newItem.position.left = '0';\n                                newItem.position.top = '0';\n                            } else {\n                                // eslint-disable-next-line max-depth\n                                if (newItem.properties.vposition == 'center-center') {\n                                    newItem.position.left = videoWidth / 2 - vwidth / 2 + 'px';\n                                    newItem.position.top = videoHeight / 2 - vheight / 2 + 'px';\n                                } else if (newItem.properties.vposition == 'center-left') {\n                                    newItem.position.left = padding + 'px';\n                                    newItem.position.top = videoHeight / 2 - vheight / 2 + 'px';\n                                } else if (newItem.properties.vposition == 'center-right') {\n                                    newItem.position.left = videoWidth - vwidth - padding + 'px';\n                                    newItem.position.top = videoHeight / 2 - vheight / 2 + 'px';\n                                } else if (newItem.properties.vposition == 'top-left') {\n                                    newItem.position.left = padding + 'px';\n                                    newItem.position.top = padding + 'px';\n                                } else if (newItem.properties.vposition == 'top-center') {\n                                    newItem.position.left = videoWidth / 2 - vwidth / 2 + 'px';\n                                    newItem.position.top = padding + 'px';\n                                } else if (newItem.properties.vposition == 'top-right') {\n                                    newItem.position.left = videoWidth - vwidth - padding + 'px';\n                                    newItem.position.top = padding + 'px';\n                                } else if (newItem.properties.vposition == 'bottom-left') {\n                                    newItem.position.left = padding + 'px';\n                                    newItem.position.top = videoHeight - vheight - padding + 'px';\n                                } else if (newItem.properties.vposition == 'bottom-center') {\n                                    newItem.position.left = videoWidth / 2 - vwidth / 2 + 'px';\n                                    newItem.position.top = videoHeight - vheight - padding + 'px';\n                                } else if (newItem.properties.vposition == 'bottom-right') {\n                                    newItem.position.left = videoWidth - vwidth - padding + 'px';\n                                    newItem.position.top = videoHeight - vheight - padding + 'px';\n                                } else {\n                                    newItem.position.left = padding + 'px';\n                                    newItem.position.top = padding + 'px';\n                                }\n                            }\n                        }\n                    }\n                    if (add && type == 'audio') {\n                        newItem.position.height = '40px';\n                        newItem.position.width = '40px';\n                        newItem.position.top = '0';\n                        newItem.position.left = '0';\n                    }\n\n                    break;\n                case 'image':\n                    newItem.position.height = 'auto';\n                    break;\n                case 'hotspot':\n                    if (add) {\n                        newItem.position.width = '5%';\n                    }\n                    break;\n            }\n\n            items.push(newItem);\n            saveTracking([newItem.id]);\n            renderItems(items, [newItem.id], false);\n        };\n\n        $(document).off('click', '.annotation-timeline-item').on('click', '.annotation-timeline-item', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $videoWrapper.find('.annotation-wrapper').removeClass('active');\n            if (!e.ctrlKey && !e.metaKey) {\n                let elementid = $(this).attr('data-item');\n                let elem = $videoWrapper.find(`.annotation-wrapper[data-item=\"${elementid}\"]`);\n                elem.trigger('click');\n            } else {\n                if ($(this).hasClass('active')) {\n                    $(this).removeClass('active');\n                } else {\n                    $(this).addClass('active');\n                }\n            }\n\n            let activeitems = $(`.annotation-timeline-item.active`);\n            if (activeitems.length == 0) {\n                $('#annotation-canvas #background').addClass('d-none').css('z-index', 0);\n                $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n                $('#annotation-btns #edit').attr('disabled', 'disabled');\n                $('#annotation-btns #edit').removeAttr('disabled');\n            } else {\n                let dataActive = activeitems.map(function() {\n                    return $(this).attr('data-item');\n                }).get();\n\n                dataActive.forEach((id) => {\n                    $videoWrapper.find(`.annotation-wrapper[data-item=${id}]`).addClass('active');\n                });\n\n                let activewrapper = $videoWrapper.find('.annotation-wrapper.active');\n                document.querySelector('.annotation-wrapper.active').focus();\n                $('#edit-btns').attr('data-active', dataActive).addClass('d-flex').removeClass('d-none');\n                if (activewrapper.length > 1) {\n                    $('#annotation-btns #edit').attr('disabled', 'disabled');\n                    $('#annotation-btns #position').addClass('d-none');\n                } else {\n                    $('#annotation-btns #edit').removeAttr('disabled');\n                    $('#annotation-btns #position').removeClass('d-none');\n                }\n\n                $('#annotation-canvas #background').removeClass('d-none').css('z-index', 3);\n            }\n        });\n\n        $(document).off('dblclick', '.annotation-timeline-item').on('dblclick', '.annotation-timeline-item', async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let currentTime = await self.player.getCurrentTime(); // We have to check if the time is different.\n            let start = $(this).attr('data-start');\n            if (currentTime == start) {\n                return;\n            }\n            self.player.seek($(this).attr('data-start'));\n            self.dispatchEvent('timeupdate', {time: $(this).attr('data-start')});\n        });\n\n        $playerWrapper.off('click', `#annotation-btns #save`).on('click', `#annotation-btns #save`, async function(e) {\n            e.stopImmediatePropagation();\n            getItems(false);\n            // Encode html tags\n            let cleanItems = JSON.stringify(items).replace(/</g, '&lt;').replace(/>/g, '&gt;');\n            let updateId = $videoWrapper.attr('data-id');\n            await $.ajax({\n                url: M.cfg.wwwroot + '/mod/interactivevideo/ajax.php',\n                method: \"POST\",\n                dataType: \"text\",\n                data: {\n                    action: 'quick_edit_field',\n                    sesskey: M.cfg.sesskey,\n                    id: updateId,\n                    field: 'content',\n                    contextid: M.cfg.contextid,\n                    draftitemid: draftitemid,\n                    value: cleanItems,\n                    cmid: self.cmid,\n                    token: self.token,\n                },\n                success: function(data) {\n                    let updated = JSON.parse(data);\n                    draftStatus = null;\n                    tracking = [];\n                    $('#annotation-btns #redo, #annotation-btns #undo').attr('disabled', 'disabled');\n                    self.dispatchEvent('annotationupdated', {\n                        annotation: updated,\n                        action: 'edit',\n                    });\n                }\n            });\n            $('#annotation-canvas #background').trigger('click');\n            return true;\n        });\n\n        $(document).off('click', `#annotation-btns #closetoolbar`).on('click', `#annotation-btns #closetoolbar`, function(e) {\n            e.stopImmediatePropagation();\n            if (draftStatus == 'draft') {\n                Notification.saveCancel(\n                    M.util.get_string('unsavedchange', 'local_ivannotation'),\n                    M.util.get_string('unsavedchangeconfirm', 'local_ivannotation'),\n                    M.util.get_string('save', 'local_ivannotation'),\n                    async function() {\n                        // If the user clicks save, save the changes.\n                        await $('#annotation-btns #save').trigger('click');\n                        draftStatus = null;\n                        tracking = [];\n                        return $(`#annotation-btns #closetoolbar`).trigger('click');\n                    },\n                    function() {\n                        // If the user clicks cancel, discard the changes.\n                        let instance = tracking[0];\n                        items = JSON.parse(instance.items);\n                        renderItems(items, instance.actives, false);\n                        draftStatus = null;\n                        tracking = [];\n                        $('#annotation-btns #redo, #annotation-btns #undo').attr('disabled', 'disabled');\n                        $(`#annotation-btns #closetoolbar`).trigger('click');\n                    }\n                );\n            } else {\n                $(`#annotation-btns`).remove();\n                $('#interaction-timeline, #video-timeline-wrapper').show();\n                $('#timeline-btns div:not(#playbutton)').css('visibility', 'visible');\n                $('#content-region').removeClass('no-pointer-events');\n                $('#annotation-timeline').hide();\n                $('#scrollbar').addClass('snap');\n                $('#annotation-canvas .annotation-wrapper').addClass('no-pointer').removeClass('active');\n            }\n        });\n\n        $playerWrapper.off('click', `#annotation-btns .add-ia`).on('click', `#annotation-btns .add-ia`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let annoid = $videoWrapper.attr('data-id');\n            let type = $(this).attr('data-mediatype');\n            let start = await self.player.getCurrentTime();\n            let end = start + 5;\n            start = parseFloat(start).toFixed(2);\n            end = parseFloat(end).toFixed(2);\n            let iaform = new ModalForm({\n                formClass: \"local_ivannotation\\\\items\\\\\" + $(this).attr('data-type'),\n                args: {\n                    contextid: M.cfg.contextid,\n                    id: 0,\n                    type: type,\n                    annotationid: annoid,\n                    start: start,\n                    end: end,\n                },\n                modalConfig: {\n                    title: M.util.get_string('addinlineannotation', 'local_ivannotation',\n                        M.util.get_string(type, 'local_ivannotation')),\n                }\n            });\n\n            iaform.show();\n\n            iaform.addEventListener(iaform.events.LOADED, () => {\n                iaform.modal.modal.draggable({\n                    handle: \".modal-header\",\n                });\n                if (type == 'navigation' || type == 'image' || type == 'shape') {\n                    $(document).on('change', '.modal [name=\"timestamp\"]', function(e) {\n                        e.preventDefault();\n                        let parts = $(this).val().split(':');\n                        let timestamp = Number(parts[0]) * 3600 + Number(parts[1]) * 60 + Number(parts[2]);\n                        if (!self.isBetweenStartAndEnd(timestamp)) {\n                            let message = M.util.get_string('timemustbebetweenstartandendtime', 'local_ivannotation', {\n                                \"start\": self.convertSecondsToHMS(self.start),\n                                \"end\": self.convertSecondsToHMS(self.end),\n                            });\n                            self.addNotification(message);\n                            $(this).val($(this).attr('data-initial-value'));\n                            return;\n                        }\n\n                        // Make sure the timestamp is not in the skip segment.\n                        if (self.isInSkipSegment(timestamp)) {\n                            self.addNotification(M.util.get_string('interactionisbetweentheskipsegment',\n                                'local_ivannotation'));\n                            $(this).val($(this).attr('data-initial-value'));\n                            return;\n                        }\n                    });\n                }\n            });\n\n            iaform.addEventListener(iaform.events.FORM_SUBMITTED, (e) => {\n                e.stopImmediatePropagation();\n                getItems(false);\n                const highestOrder = getTopLayer(items);\n                let left = Math.random() * 100;\n                let top = Math.random() * 100;\n                let newItem = {\n                    \"id\": new Date().getTime(),\n                    \"type\": type,\n                    \"position\": {\n                        \"width\": \"30%\",\n                        \"left\": left + \"px\",\n                        \"top\": top + \"px\",\n                        \"z-index\": highestOrder + 1,\n                    },\n                    'properties': e.detail,\n                };\n                handleFormData(newItem, type, true);\n            });\n        });\n\n        $playerWrapper.off('click', `#annotation-btns #edit`).on('click', `#annotation-btns #edit`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let annnoid = $videoWrapper.attr('data-id');\n            let active = $('#edit-btns').attr('data-active');\n            getItems(false);\n            let item = items.find(x => x.id == active);\n            let type = item.type;\n            let formdata = JSON.parse(JSON.stringify(item.properties));\n            formdata.contextid = M.cfg.contextid;\n            formdata.id = item.id;\n            formdata.annotationid = annnoid;\n            formdata.type = type;\n            let editform = new ModalForm({\n                formClass: \"local_ivannotation\\\\items\\\\\" +\n                    (type == 'image' || type == 'file' || type == 'video' || type == 'audio' ? 'media' : type),\n                args: formdata,\n                modalConfig: {\n                    title: M.util.get_string('editinlineannotation', 'local_ivannotation',\n                        M.util.get_string(type, 'local_ivannotation')),\n                }\n            });\n\n            editform.show();\n\n            editform.addEventListener(editform.events.LOADED, () => {\n                editform.modal.modal.draggable({\n                    handle: \".modal-header\",\n                });\n            });\n\n            editform.addEventListener(editform.events.FORM_SUBMITTED, (e) => {\n                e.stopImmediatePropagation();\n                getItems(false);\n                item = items.find(x => x.id == active);\n                item.properties = e.detail;\n                // Remove the item from the annotation-canvas\n                $videoWrapper.find(`.annotation-wrapper[data-item=\"${active}\"]`).remove();\n                items = items.filter(x => x.id != active);\n                handleFormData(item, type, false);\n            });\n        });\n\n        $videoWrapper.off('click', `.annotation-wrapper`).on('click', `.annotation-wrapper`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            await self.player.pause();\n            if (!e.ctrlKey && !e.metaKey) {\n                $videoWrapper.find('.annotation-wrapper').removeClass('active');\n                $(this).addClass('active');\n                this.focus();\n                recalculatingSize($(this));\n            } else {\n                if ($(this).hasClass('active')) {\n                    $(this).removeClass('active');\n                } else {\n                    $(this).addClass('active');\n                    this.focus();\n                }\n            }\n\n            if (!isNaN($(this).attr('data-group'))) {\n                let group = $(this).attr('data-group');\n                $videoWrapper.find(`.annotation-wrapper[data-group=\"${group}\"]`).addClass('active');\n            }\n\n            recalculatingSize($(this));\n\n            $(`#timeline #annotation-timeline .annotation-timeline-item`).removeClass('active');\n            let activewrapper = $videoWrapper.find('.annotation-wrapper.active');\n            if (activewrapper.length == 0) {\n                $('#annotation-canvas #background').addClass('d-none').css('z-index', 0);\n                $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n                $('#annotation-btns #edit').attr('disabled', 'disabled');\n                $('#annotation-btns #edit').removeAttr('disabled');\n            } else {\n                let dataActive = activewrapper.map(function() {\n                    return $(this).attr('data-item');\n                }).get();\n\n                dataActive.forEach((id) => {\n                    $(`#timeline #annotation-timeline .annotation-timeline-item[data-item=\"${id}\"]`).addClass('active');\n                });\n\n                $('#edit-btns').attr('data-active', dataActive).addClass('d-flex').removeClass('d-none');\n                if (activewrapper.length > 1) {\n                    $('#annotation-btns #edit').attr('disabled', 'disabled');\n                    $('#edit-btns #position').addClass('d-none');\n                } else {\n                    $('#annotation-btns #edit').removeAttr('disabled');\n                    $('#edit-btns #position').removeClass('d-none');\n                }\n                $('#annotation-canvas #background').removeClass('d-none').css('z-index', 1);\n            }\n\n            // Enable ungroup button if the active items are grouped.\n            let grouping = activewrapper.map(function() {\n                if (isNaN($(this).attr('data-group')) || $(this).attr('data-group') == '') {\n                    return '';\n                }\n                return $(this).attr('data-group');\n            }).get();\n\n            grouping = [...new Set(grouping)];\n            if (activewrapper.length < 2) {\n                $('#annotation-btns #ungroup, #annotation-btns #group').attr('disabled', 'disabled').addClass('d-none');\n            } else {\n                if (grouping.length == 1) {\n                    if (isNaN(grouping[0]) || grouping[0] == '') {\n                        $('#annotation-btns #ungroup').attr('disabled', 'disabled').addClass('d-none');\n                        $('#annotation-btns #group').removeAttr('disabled').removeClass('d-none');\n                    } else {\n                        $('#annotation-btns #ungroup').removeAttr('disabled').removeClass('d-none');\n                        $('#annotation-btns #group').attr('disabled', 'disabled').addClass('d-none');\n                    }\n                } else if (grouping.length > 1) {\n                    $('#annotation-btns #ungroup, #annotation-btns #group').removeAttr('disabled').removeClass('d-none');\n                }\n            }\n        });\n\n        $videoWrapper.off('dblclick', '.annotation-wrapper').on('dblclick', '.annotation-wrapper', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).trigger('click');\n            $('#annotation-btns #edit').trigger('click');\n        });\n\n        $(document).off('click', '#annotation-canvas #background').on('click', '#annotation-canvas #background', function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $('#annotation-canvas .annotation-wrapper').removeClass('active');\n            $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n            $(`#timeline #annotation-timeline .annotation-timeline-item`).removeClass('active');\n            $('#annotation-canvas #background').addClass('d-none').css('z-index', 0);\n        });\n\n        $(document).off('click', `#annotation-btns #undo`).on('click', `#annotation-btns #undo`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            if (trackingIndex == 0) {\n                return;\n            }\n            trackingIndex--;\n            const instance = tracking[trackingIndex];\n            items = JSON.parse(instance.items);\n            renderItems(items, instance.actives, false);\n            self.player.seek(instance.timestamp);\n            if (trackingIndex == 0) {\n                $('#annotation-btns #undo').attr('disabled', 'disabled');\n                $('#annotation-btns #redo').removeAttr('disabled');\n            } else {\n                $('#annotation-btns #undo').removeAttr('disabled');\n                if (trackingIndex == tracking.length - 1) {\n                    $('#annotation-btns #redo').attr('disabled', 'disabled');\n                } else {\n                    $('#annotation-btns #redo').removeAttr('disabled');\n                }\n            }\n        });\n\n        $(document).off('click', `#annotation-btns #redo`).on('click', `#annotation-btns #redo`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            if (trackingIndex == tracking.length - 1) {\n                return;\n            }\n            trackingIndex++;\n            const instance = tracking[trackingIndex];\n            items = JSON.parse(instance.items);\n            renderItems(items, instance.actives, false);\n            self.player.seek(instance.timestamp);\n            if (trackingIndex == tracking.length - 1) {\n                $('#annotation-btns #redo').attr('disabled', 'disabled');\n                $('#annotation-btns #undo').removeAttr('disabled');\n            } else {\n                $('#annotation-btns #redo').removeAttr('disabled');\n                if (trackingIndex == 0) {\n                    $('#annotation-btns #undo').attr('disabled', 'disabled');\n                } else {\n                    $('#annotation-btns #undo').removeAttr('disabled');\n                }\n            }\n        });\n\n        const updateOrder = (active, direction) => {\n            // First sort items by z-index descending\n            getItems(false);\n            items.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n            let activeIndex = items.findIndex(x => x.id == active);\n            let activeItem = items[activeIndex];\n            let currentzIndex = activeItem.position['z-index'];\n            let affectedItem = null;\n            let affectedItemIndex = null;\n            if (direction == 'up') {\n                if (activeIndex == 0) {\n                    return;\n                }\n                affectedItemIndex = activeIndex - 1;\n                affectedItem = items[affectedItemIndex];\n                activeItem.position['z-index'] = affectedItem.position['z-index'];\n                affectedItem.position['z-index'] = currentzIndex;\n            } else {\n                if (activeIndex == items.length - 1) {\n                    return;\n                }\n                affectedItemIndex = activeIndex + 1;\n                affectedItem = items[affectedItemIndex];\n                activeItem.position['z-index'] = affectedItem.position['z-index'];\n                affectedItem.position['z-index'] = currentzIndex;\n            }\n            items[activeIndex] = activeItem;\n            items[affectedItemIndex] = affectedItem;\n            $(`.annotation-wrapper[data-item=\"${active}\"]`).css(activeItem.position);\n            $(`.annotation-wrapper[data-item=\"${affectedItem.id}\"]`).css(affectedItem.position);\n            saveTracking([active]);\n        };\n\n        // Group the active items\n        $(document).off('click', `#annotation-btns #group`).on('click', `#annotation-btns #group`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).attr('disabled', 'disabled').addClass('d-none');\n            $('#annotation-btns #ungroup').removeAttr('disabled').removeClass('d-none');\n            getItems(false);\n            let active = $('.annotation-wrapper.active').map(function() {\n                return $(this).attr('data-item');\n            }).get();\n            const group = new Date().getTime();\n            active.forEach((item) => {\n                let activeItem = $(`.annotation-wrapper[data-item=\"${item}\"]`);\n                let targetIndex = items.findIndex(x => x.id == item);\n                let target = JSON.parse(JSON.stringify(items[targetIndex]));\n                target.position.group = group;\n                activeItem.attr('data-group', target.position.group);\n                items[targetIndex] = target;\n            });\n            renderItems(items, active, false);\n            saveTracking(active);\n        });\n\n        $(document).off('click', `#annotation-btns #ungroup`).on('click', `#annotation-btns #ungroup`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            $(this).attr('disabled', 'disabled').addClass('d-none');\n            $(`#annotation-btns #group`).removeAttr('disabled').removeClass('d-none');\n            getItems(false);\n            let active = $('.annotation-wrapper.active').map(function() {\n                return $(this).attr('data-item');\n            }).get();\n            active.forEach((item) => {\n                let activeItem = $(`.annotation-wrapper[data-item=\"${item}\"]`);\n                let targetIndex = items.findIndex(x => x.id == item);\n                let target = JSON.parse(JSON.stringify(items[targetIndex]));\n                delete target.position.group;\n                activeItem.attr('data-group', '');\n                items[targetIndex] = target;\n            });\n            renderItems(items, active, false);\n            saveTracking(active);\n        });\n\n        // Increase the z-index of the active items\n        $(document).off('click', `#annotation-btns #up`).on('click', `#annotation-btns #up`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            const topLayer = getTopLayer(items);\n            // Check if the active elements are already in the correct order based on their index positions in the items array\n            if (active.length > 1) {\n                active = sortItemsByLayer(active, 'desc');\n                let indexes = [];\n                items.sort((a, b) => b.position['z-index'] - a.position['z-index']);\n                active.forEach((item) => {\n                    indexes.push(items.findIndex(x => x.id == item));\n                });\n                indexes.sort((a, b) => a - b);\n                if (Math.abs(indexes[0] - indexes[indexes.length - 1]) == active.length - 1) {\n                    if (Number(items[indexes[0]].position['z-index']) == topLayer) {\n                        return;\n                    }\n                }\n            }\n            active.forEach((item) => {\n                updateOrder(item, 'up');\n            });\n            getItems(false);\n            updatePositionInfo($(`.annotation-wrapper[data-item=\"${active[0]}\"]`));\n            renderTimelineItems(items, active);\n        });\n\n        // Decrease the z-index of the active items\n        $(document).off('click', `#annotation-btns #down`).on('click', `#annotation-btns #down`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            const bottomLayer = getBottomLayer(items);\n            // Check if the active elements are already in the correct order based on their index positions in the items array\n            if (active.length > 1) {\n                active = sortItemsByLayer(active, 'asc');\n                let indexes = [];\n                items.sort((a, b) => a.position['z-index'] - b.position['z-index']);\n                active.forEach((item) => {\n                    indexes.push(items.findIndex(x => x.id == item));\n                });\n                indexes.sort((a, b) => a - b);\n                if (Math.abs(indexes[0] - indexes[indexes.length - 1]) == active.length - 1) {\n                    if (Number(items[indexes[0]].position['z-index']) == bottomLayer) {\n                        return;\n                    }\n                }\n            }\n            active.forEach((item) => {\n                updateOrder(item, 'down');\n            });\n            getItems(false);\n            updatePositionInfo($(`.annotation-wrapper[data-item=\"${active[0]}\"]`));\n            renderTimelineItems(items, active);\n        });\n\n        // Delete the active items\n        $playerWrapper.off('click', `#annotation-btns #delete`).on('click', `#annotation-btns #delete`, function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            active.forEach((item) => {\n                let activeItem = $(`.annotation-wrapper[data-item=\"${item}\"]`);\n                activeItem.remove();\n                $('#edit-btns').attr('data-active', '').addClass('d-none').removeClass('d-flex');\n            });\n            getItems(false);\n            renderTimelineItems(items, null);\n            saveTracking(null);\n        });\n\n        // Duplicate the active items.\n        $playerWrapper.off('click', `#annotation-btns #copy`).on('click', `#annotation-btns #copy`, async function(e) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            getItems(false);\n            // Copy the active item.\n            const highestOrder = getTopLayer(items);\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            active = sortItemsByLayer(active, 'asc');\n            const currentTime = await self.player.getCurrentTime();\n            let newItems = [];\n            let groupIncrement = Math.round(Math.random() * 100);\n            for (let i = 0; i < active.length; i++) {\n                let a = active[i];\n                let activeItem = $(`.annotation-wrapper[data-item=\"${a}\"]`);\n                activeItem.removeClass('active');\n                const item = items.find(x => x.id == a);\n                let newItem = JSON.parse(JSON.stringify(item));\n                newItem.properties.end = currentTime + (newItem.properties.end - newItem.properties.start);\n                newItem.properties.start = currentTime;\n                newItem.position = recalculatingSize(activeItem);\n                if (item.position.group) {\n                    newItem.position.group = Number(item.position.group) + groupIncrement;\n                }\n                newItem.id = new Date().getTime() + i;\n                newItems.push(newItem.id);\n                newItem.position['z-index'] = Number(highestOrder) + i + 1;\n                items.push(newItem);\n                renderItems(items, null, false);\n                if (i == active.length - 1) {\n                    $('#edit-btns').attr('data-active', newItems.join(',')).addClass('d-flex').removeClass('d-none');\n                    // Put focus on the first element\n                    renderItems([], newItems, true);\n                    setTimeout(() => {\n                        getItems(false);\n                        document.querySelector('.annotation-wrapper.active').focus();\n                        updatePositionInfo($videoWrapper.find(`.annotation-wrapper[data-item=\"${newItem.id}\"]`));\n                        self.dispatchEvent('timeupdate', {time: currentTime});\n                        saveTracking(newItems);\n                    }, 500);\n                }\n            }\n        });\n\n        // Move items with keyboard arrow keys, ctrl + up to layer up, and ctrl + down to layer down.\n        $playerWrapper.on('keydown', '.annotation-wrapper:not(.notresizable)', function(e) {\n            let active = $('#edit-btns').attr('data-active');\n            active = active.split(',');\n            getItems(false);\n            for (let i = 0; i < active.length; i++) {\n                let a = active[i];\n                let activeItem = $(`.annotation-wrapper[data-item=\"${a}\"]`);\n                if (activeItem != undefined) {\n                    let position = activeItem.position();\n                    let ctrl = e.ctrlKey || e.metaKey;\n                    let step = 1;\n                    // Prevent page scroll\n                    e.preventDefault();\n                    e.stopImmediatePropagation();\n                    switch (e.key) {\n                        case 'ArrowUp':\n                            if (position.top > 0) {\n                                position.top = position.top - step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'ArrowDown':\n                            if (position.top + activeItem.outerHeight() < $videoWrapper.height()) {\n                                position.top = position.top + step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'ArrowLeft':\n                            if (position.left > 0) {\n                                position.left = position.left - step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'ArrowRight':\n                            if (position.left + activeItem.outerWidth() < $videoWrapper.width()) {\n                                position.left = position.left + step;\n                                saveTracking(active);\n                            }\n                            break;\n                        case 'Delete':\n                            $(`#annotation-btns #delete`).trigger('click');\n                            return;\n                        case 'd': // Ctrl + d to duplicate\n                            if (ctrl) {\n                                $(`#annotation-btns #copy`).trigger('click');\n                            }\n                            return;\n                        default:\n                            return;\n                    }\n                    activeItem.css(position);\n                    recalculatingSize(activeItem);\n                }\n            }\n        });\n\n        // Listen to the annotationupdated event\n        $(document).on('annotationdeleted', function(e) {\n            let deleted = e.originalEvent.detail.annotation;\n            let annoid = $videoWrapper.attr('data-id');\n            if (annoid == deleted.id) {\n                $videoWrapper.find('.annotation-wrapper').remove();\n                $(`#annotation-btns`).remove();\n                $(`#timeline #annotation-timeline .annotation-timeline-item`).remove();\n            }\n        });\n\n        // Confirm draft saved.\n        window.addEventListener('beforeunload', (e) => {\n            if (draftStatus !== null) {\n                const confirmationMessage = M.util.get_string('unsavedchanges', 'mod_interactivevideo');\n                e.returnValue = confirmationMessage;\n                return confirmationMessage;\n            }\n            return true;\n        });\n\n        self.timepicker();\n    }\n\n    /**\n     * Override the render method to add the items on the list of editing annotations\n     * @param {Array} annotations The annotations array\n     * @param {Object} listItem The list item\n     * @param {Object} item The annotation object\n     * @returns {void}\n     */\n    async renderEditItem(annotations, listItem, item) {\n        this.annotations = annotations;\n        listItem.removeAttr('id').removeClass('d-none');\n        listItem.attr('data-type', item.type);\n        listItem.addClass(item.type);\n        listItem.attr('data-id', item.id);\n        listItem.removeAttr('data-timestamp');\n        listItem.find('.timestamp').remove();\n        listItem.find('.title').text(M.util.get_string('pluginname', 'local_ivannotation')).addClass('no-pointer text-dark');\n        listItem.find('.btn.xp').remove();\n        listItem.find('.type-icon i').addClass(this.prop.icon);\n        listItem.find('.type-icon').attr('title', this.prop.title);\n        listItem.find('.btn.copy').remove();\n        listItem.appendTo('#annotation-list');\n        return listItem;\n    }\n\n    /**\n     * Edit an annotation\n     * @param {Array} annotations The annotations array\n     * @param {number} id The annotation id\n     * @returns {void}\n     */\n    async editAnnotation(annotations, id) {\n        this.annotations = annotations;\n        let item = this.annotations.find((annotation) => annotation.id == id);\n        $('#annotation-canvas').attr('data-id', item.id);\n        $('#interaction-timeline, #video-timeline-wrapper').hide();\n        $('#timeline-btns div:not(#playbutton)').css('visibility', 'hidden');\n        $('#content-region').addClass('no-pointer-events');\n        $('#annotation-timeline').show();\n        $('#annotation-canvas .annotation-wrapper').removeClass('no-pointer');\n        $('#scrollbar').removeClass('snap');\n        this.renderAnnotationToolbar(item);\n    }\n\n    /**\n     * Add an annotation to the annotation list without the form as other annotation\n     * @param {Array} annotations Array of annotations\n     * @param {Number} timestamp timestamp\n     * @param {Number} coursemodule Course module id\n     * @returns void\n     */\n    async addAnnotation(annotations, timestamp, coursemodule) {\n        let self = this;\n        let data = {\n            title: self.prop.title,\n            timestamp: -1,\n            contextid: M.cfg.contextid,\n            type: self.prop.name,\n            courseid: self.course,\n            cmid: coursemodule,\n            annotationid: self.interaction,\n            hascompletion: 0,\n            advanced: JSON.stringify({\n                \"visiblebeforecompleted\": \"1\",\n                \"visibleaftercompleted\": null,\n                \"clickablebeforecompleted\": \"1\",\n                \"clickableaftercompleted\": null,\n                \"replaybehavior\": \"1\",\n            }),\n        };\n        let ajax = await Ajax.call([{\n            methodname: 'local_ivannotation_add',\n            args: {\n                annotationdata: JSON.stringify(data),\n            },\n            contextid: M.cfg.contextid,\n        }])[0];\n\n        let newAnnotation = JSON.parse(ajax.data);\n        self.dispatchEvent('annotationupdated', {\n            annotation: newAnnotation,\n            action: 'add'\n        });\n\n        self.annotations = annotations;\n        $('#contentmodal').modal('hide');\n        newAnnotation.editmode = true;\n        const content = await self.render(newAnnotation, 'json');\n        $('#annotation-canvas').attr('data-id', newAnnotation.id);\n        self.postContentRender(newAnnotation, content);\n        self.editAnnotation(annotations, newAnnotation.id);\n    }\n\n    /**\n     * What happens when an item runs\n     * @param {Object} annotation The annotation object\n     * @returns {Object} The annotation object\n     */\n    runInteraction(annotation) {\n        return annotation;\n    }\n}"],"names":["Annotation","Base","roundToTwo","num","Math","round","videoWrapper","self","this","item","annotations","find","annotation","type","isEditMode","attr","id","editmode","content","render","postContentRender","updateAspectRatio","async","video","reset","elem","hasClass","ratio","displayoptions","usefixedratio","player","aspectratio","videowrapperaspect","width","height","videowrapperwidth","videowrapperheight","css","resizeTimeout","vwrapper","document","querySelector","ResizeObserver","clearTimeout","setTimeout","observe","on","off","closest","remove","annos","map","start","Number","end","duration","get","pause","dispatchEvent","time","getCurrentTime","e","originalEvent","detail","main","x","length","t","hasMute","visibles","filter","hiddens","toShow","activated","toHide","undefined","isPaused","play","addClass","removeClass","forEach","anno","includes","muteElem","isMuted","mute","unMute","rate","playbackRate","currentTime","annotationitems","M","util","get_string","dataForTemplate","items","html","Templates","append","enableColorPicker","data","$videoWrapper","$playerWrapper","draftStatus","convertSecondsToMMSS","seconds","rounded","hours","floor","minutes","sec","formattedTime","updatePositionInfo","w","outerWidth","hw","outerHeight","position","top","l","left","z","s","$position","text","recalculatingSize","message","h","g","group","recalculatingTextSize","button","multiline","fontSize","padding","rowCount","style","renderTimelineItems","elements","activeids","parseInt","$timelinewrapper","timeline","empty","sort","a","b","count","timelineHTML","i","prop","properties","draggable","trigger","$selected","each","timestampScrollbar","ui","timestamp","totaltime","now","$annowrapper","distance","originalPosition","not","$this","elementid","itemIndex","findIndex","saveTracking","renderItems","resizable","originalSize","size","newStart","newEnd","leftPercentage","newWidth","$scrollbar","clone","actives","update","active","Promise","resolve","createElement","src","url","onloadedmetadata","videoDuration","wrapper","replace","parts","split","gotourl","shadow","formattedalttext","renderImage","wrapperhtml","formattedlabel","hidden","renderFile","renderNavigation","bold","italic","underline","textcolor","bgcolor","borderwidth","bordercolor","textfont","renderText","textparts","textblock","part","trim","alignment","lineHeight","renderTextBlock","opacity","shape","renderShape","formattedtitle","color","usemodal","isBS5","popover","container","template","$body","formatContent","contextid","openbydefault","renderHotspot","srcType","endsWith","muted","load","playsInline","dismissable","freesize","videoTime","abs","renderVideo","icon","renderLink","formatteddesc","viewport","renderMessage","aspectRatio","videoWidth","videoHeight","is","containment","cursor","grid","handle","getItems","drag","event","positions","bottom","right","target","stop","newLeft","newTop","handles","minHeight","minWidth","resize","ctrlKey","stopImmediatePropagation","hotspotid","hotspot","title","modal","fadeIn","seek","existingwrapper","$annotationContent","tracking","trackingIndex","JSON","parse","push","stringify","draftitemid","slice","at","Date","getTime","removeAttr","sortItemsByLayer","ids","order","toString","targetItems","getTopLayer","itms","sorted","zindex","updateid","newItems","index","element","handleFormData","newItem","add","thisvideo","vwidth","vheight","vposition","preventDefault","metaKey","activeitems","dataActive","activewrapper","focus","cleanItems","updateId","$","ajax","cfg","wwwroot","method","dataType","action","sesskey","field","value","cmid","token","success","updated","saveCancel","instance","show","hide","annoid","parseFloat","toFixed","iaform","ModalForm","formClass","args","annotationid","modalConfig","addEventListener","events","LOADED","val","isBetweenStartAndEnd","convertSecondsToHMS","addNotification","isInSkipSegment","FORM_SUBMITTED","highestOrder","random","annnoid","formdata","editform","isNaN","grouping","Set","updateOrder","direction","activeIndex","activeItem","currentzIndex","affectedItem","affectedItemIndex","targetIndex","topLayer","indexes","bottomLayer","getBottomLayer","groupIncrement","join","ctrl","step","key","deleted","window","confirmationMessage","returnValue","timepicker","listItem","appendTo","renderAnnotationToolbar","coursemodule","name","courseid","course","interaction","hascompletion","advanced","Ajax","call","methodname","annotationdata","newAnnotation","editAnnotation","runInteraction"],"mappings":"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"}